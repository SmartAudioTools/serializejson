

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>serializejson &mdash; serializejson 0.0.4 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> serializejson
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">serializejson</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>serializejson</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for serializejson</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">serializejson</span>
<span class="sd">=============</span>

<span class="sd">+---------------------------+--------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">| **Authors**               | `Baptiste de La Gorce &lt;contact@smartaudiotools.com&gt;`_                                                                    |</span>
<span class="sd">+---------------------------+--------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">| **PyPI**                  | https://pypi.org/project/serializejson                                                                                   |</span>
<span class="sd">+---------------------------+--------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">| **Documentation**         | https://smartaudiotools.github.io/serializejson                                                                          |</span>
<span class="sd">+---------------------------+--------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">| **Sources**               | https://github.com/SmartAudioTools/serializejson                                                                         |</span>
<span class="sd">+---------------------------+--------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">| **Issues**                | https://github.com/SmartAudioTools/serializejson/issues                                                                  |</span>
<span class="sd">+---------------------------+--------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">| **Noncommercial license** | `Prosperity Public License 3.0.0 &lt;https://github.com/SmartAudioTools/serializejson/blob/master/LICENSE-PROSPERITY.rst&gt;`_ |</span>
<span class="sd">+---------------------------+--------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">| **Commercial license**    | `Patron License 1.0.0 &lt;https://github.com/SmartAudioTools/serializejson/blob/master/LICENSE-PATRON.rst&gt;`_                |</span>
<span class="sd">|                           | ⇒ `Sponsor me ! &lt;https://github.com/sponsors/SmartAudioTools&gt;`_ or `contact me ! &lt;contact@smartaudiotools.com&gt;`_         |</span>
<span class="sd">+---------------------------+--------------------------------------------------------------------------------------------------------------------------+</span>


<span class="sd">**serializejson**  is a python library for fast serialization and deserialization</span>
<span class="sd">of python objects in `JSON &lt;http://json.org&gt;`_  designed as a safe, interoperable and human-readable drop-in replacement for the Python `pickle &lt;https://docs.python.org/3/library/pickle.html&gt;`_ package.</span>
<span class="sd">Complex python object hierarchies are serializable, deserializable or updatable in once, allowing for example to save or restore a complete application state in few lines of code.</span>
<span class="sd">The library is build upon</span>
<span class="sd">`python-rapidjson &lt;https://github.com/python-rapidjson/python-rapidjson&gt;`_,</span>
<span class="sd">`pybase64 &lt;https://github.com/mayeut/pybase64&gt;`_ and</span>
<span class="sd">`blosc &lt;https://github.com/Blosc/python-blosc&gt;`_  for optional `zstandard &lt;https://github.com/facebook/zstd&gt;`_ compression.</span>

<span class="sd">Some of the main features:</span>

<span class="sd">- supports Python 3.7 (maybe lower) or greater.</span>
<span class="sd">- serializes arbitrary python objects into a dictionary by adding `__class__` ,and eventually `__init__`, `__new__`, `__state__`, `__items__` keys.</span>
<span class="sd">- calls the same objects methods as pickle. Therefore almost all pickable objects are serializable with serializejson without any modification.</span>
<span class="sd">- for not already pickable object, you will allways be able to serialize it by adding methodes to the object or creating plugins for pickle or serializejson.</span>
<span class="sd">- generally 2x slower than pickle for dumping and 3x slower than pickle for loading (on your benchmark) except for big arrays (optimisation will soon be done).</span>
<span class="sd">- serializes and deserializes bytes and bytearray very quickly in base64 thanks to `pybase64 &lt;https://github.com/mayeut/pybase64&gt;`_ and lossless `blosc &lt;https://github.com/Blosc/python-blosc&gt;`_ compression.</span>
<span class="sd">- serialize properties and attributes with getters and setters if wanted (unlike pickle).</span>
<span class="sd">- json data will still be directly loadable if you have transform some attributes in slots or properties in your code since your last serialization. (unlike pickle)</span>
<span class="sd">- can serialize `__init__(self,..)` arguments by name instead of positions, allowing to skip arguments with defauts values and making json datas robust to a change of `__init__` parameters order.</span>
<span class="sd">- serialized objects take generally less space than when serialized with pickle: for binary data, the 30% increase due to base64 encoding is in general largely compensated using the lossless `blosc &lt;https://github.com/Blosc/python-blosc&gt;`_ compression.</span>
<span class="sd">- serialized objects are human-readable and easy to read. Unlike pickled data, your data will never become unreadable if your code evolves: you will always be able to modify your datas with a text editor (with find &amp; replace for example if you change an attribut name).</span>
<span class="sd">- serialized objects are text and therefore versionable and comparable with versionning and comparaison tools.</span>
<span class="sd">- can safely load untrusted / unauthenticated sources if authorized_classes list parameter is set carefully with strictly necessary objects (unlike pickle).</span>
<span class="sd">- can update existing objects recursively instead of override them. serializejson can be used to save and restore in place a complete application state (⚠ not yet well tested).</span>
<span class="sd">- filters attribute starting with &quot;_&quot; by default (unlike pickle). You can keep them if wanted with `filter_ = False`.</span>
<span class="sd">- numpy arrays can be serialized as lists with automatic conversion in both ways or in a conservative way.</span>
<span class="sd">- supports circular references and serialize only once duplicated objects, using &quot;$ref&quot; key an path to the first occurance in the json : `{&quot;$ref&quot;: &quot;root.xxx.elt&quot;}` (⚠ not yet if the object is a list or dictionary).</span>
<span class="sd">- accepts json with comment (// and /\* \*/) if `accept_comments = True`.</span>
<span class="sd">- can automatically recognize objects in json from keys names and recreate them, without the need of `__class__` key, if passed in `recognized_classes`.</span>
<span class="sd">- serializejson is easly interoperable outside of the Python ecosystem with this recognition of objects from keys names or with `__class__` translation between python and other language classes.</span>
<span class="sd">- dump and load support string path.</span>
<span class="sd">- can iteratively encode (with append) and decode (with iterator) a list in json file, which helps saving memory space during the process of serialization and deserialization and useful for logs.</span>

<span class="sd">.. warning::</span>

<span class="sd">    **⚠** Do not load serializejson files from untrusted / unauthenticated sources without carefully setting the load authorized_classes parameter.</span>

<span class="sd">    **⚠** Never dump a dictionary with the `__class__` key, otherwise serializejson will attempt to reconstruct an object when loading the json.</span>
<span class="sd">    Be careful not to allow a user to manually enter a dictionary key somewhere without checking that it is not `__class__`.</span>
<span class="sd">    Due to current limitation of rapidjson we cannot we cannot at the moment efficiently detect dictionaries with the `__class__` key to raise an error.</span>


<span class="sd">Installation</span>
<span class="sd">============</span>

<span class="sd">**Last offical release**</span>

<span class="sd">.. code-block::</span>

<span class="sd">    pip install serializejson</span>

<span class="sd">**Developpement version unreleased**</span>

<span class="sd">.. code-block::</span>

<span class="sd">    pip install git+https://github.com/SmartAudioTools/serializejson.git</span>

<span class="sd">Examples</span>
<span class="sd">================</span>

<span class="sd">**Serialization with fonctions API**</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    import serializejson</span>

<span class="sd">    # serialize in string</span>
<span class="sd">    object1 = set([1,2])</span>
<span class="sd">    dumped1 = serializejson.dumps(object1)</span>
<span class="sd">    loaded1 = serializejson.loads(dumped1)</span>
<span class="sd">    print(dumped1)</span>
<span class="sd">    &gt;{</span>
<span class="sd">    &gt;        &quot;__class__&quot;: &quot;set&quot;,</span>
<span class="sd">    &gt;        &quot;__init__&quot;: [1,2]</span>
<span class="sd">    &gt;}</span>


<span class="sd">    # serialize in file</span>
<span class="sd">    object2 = set([3,4])</span>
<span class="sd">    serializejson.dump(object2,&quot;dumped2.json&quot;)</span>
<span class="sd">    loaded2 = serializejson.load(&quot;dumped2.json&quot;)</span>

<span class="sd">**Serialization with classes based API.**</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    import serializejson</span>
<span class="sd">    encoder = serializejson.Encoder()</span>
<span class="sd">    decoder = serializejson.Decoder()</span>

<span class="sd">    # serialize in string</span>

<span class="sd">    object1 = set([1,2])</span>
<span class="sd">    dumped1 = encoder.dumps(object1)</span>
<span class="sd">    loaded1 = decoder.loads(dumped1)</span>
<span class="sd">    print(dumped1)</span>

<span class="sd">    # serialize in file</span>
<span class="sd">    object2 = set([3,4])</span>
<span class="sd">    encoder.dump(object2,&quot;dumped2.json&quot;)</span>
<span class="sd">    loaded2 = decoder.load(&quot;dumped2.json&quot;)</span>

<span class="sd">**Update existing object**</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    import serializejson</span>
<span class="sd">    object1 = set([1,2])</span>
<span class="sd">    object2 = set([3,4])</span>
<span class="sd">    dumped1 = serializejson.dumps(object1)</span>
<span class="sd">    print(f&quot;id {id(object2)} :  {object2}&quot;)</span>
<span class="sd">    serializejson.loads(dumped1,obj = object2, updatables_classes = [set])</span>
<span class="sd">    print(f&quot;id {id(object2)} :  {object2}&quot;)</span>

<span class="sd">**Iterative serialization and deserialization**</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    import serializejson</span>
<span class="sd">    encoder = serializejson.Encoder(&quot;my_list.json&quot;,indent = None)</span>
<span class="sd">    for elt in range(3):</span>
<span class="sd">        encoder.append(elt)</span>
<span class="sd">    print(open(&quot;my_list.json&quot;).read())</span>
<span class="sd">    for elt in serializejson.Decoder(&quot;my_list.json&quot;):</span>
<span class="sd">        print(elt)</span>
<span class="sd">    &gt;[0,1,2]</span>
<span class="sd">    &gt;0</span>
<span class="sd">    &gt;1</span>
<span class="sd">    &gt;2</span>

<span class="sd">More examples and complete documentation `here &lt;https://smartaudiotools.github.io/serializejson/&gt;`_</span>

<span class="sd">License</span>
<span class="sd">=======</span>

<span class="sd">Copyright 2020 Baptiste de La Gorce</span>

<span class="sd">For noncommercial use or thirty-day limited free-trial period commercial use, this project is licensed under the `Prosperity Public License 3.0.0 &lt;https://github.com/SmartAudioTools/serializejson/blob/master/LICENSE-PROSPERITY.rst&gt;`_.</span>

<span class="sd">For non limited commercial use, this project is licensed under the `Patron License 1.0.0 &lt;https://github.com/SmartAudioTools/serializejson/blob/master/LICENSE-PATRON.rst&gt;`_.</span>
<span class="sd">To acquire a license please `contact me &lt;mailto:contact@smartaudiotools.com&gt;`_, or just `sponsor me on GitHub &lt;https://github.com/sponsors/SmartAudioTools&gt;`_ under the appropriate tier ! This funding model helps me making my work sustainable and compensates me for the work it took to write this crate!</span>

<span class="sd">Third-party contributions are licensed under `Apache License, Version 2.0 &lt;http://www.apache.org/licenses/LICENSE-2.0&gt;`_ and belong to their respective authors.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">importlib.metadata</span> <span class="k">as</span> <span class="nn">importlib_metadata</span>  <span class="c1"># New in version 3.8</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">importlib_metadata</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">__version__</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;serializejson&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">rapidjson</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">blosc</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="nn">pybase64</span> <span class="kn">import</span> <span class="n">b64decode</span><span class="p">,</span> <span class="n">b64encode_as_string</span>
<span class="kn">from</span> <span class="nn">_collections_abc</span> <span class="kn">import</span> <span class="n">list_iterator</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">numpy</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">ndarray</span>

    <span class="n">use_numpy</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="n">use_numpy</span> <span class="o">=</span> <span class="kc">False</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">serialize_parameters</span>


<span class="c1"># def add_authorized_classes(*classes):</span>
<span class="c1">#    if len(classes) == 0 and type(classes[0]) in (tuple,list,set):</span>
<span class="c1">#        classes = classes[0]</span>
<span class="c1">#    for elt in classes:</span>
<span class="c1">#        if not type(elt) is str:</span>
<span class="c1">#            elt = class_str_from_class(elt)</span>
<span class="c1">#        authorized_classes.add(elt)</span>

<span class="kn">from</span> <span class="nn">.tools</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">getstate</span><span class="p">,</span>
    <span class="n">setstate</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">,</span>
    <span class="n">tuple_from_instance</span><span class="p">,</span>
    <span class="n">class_str_from_class</span><span class="p">,</span>
    <span class="n">class_from_class_str</span><span class="p">,</span>
    <span class="n">from_name</span><span class="p">,</span>
    <span class="n">_get_getters</span><span class="p">,</span>
    <span class="n">_get_setters</span><span class="p">,</span>
    <span class="n">_get_properties</span><span class="p">,</span>
    <span class="n">encoder_parameters</span><span class="p">,</span>
    <span class="n">_onlyOneDimSameTypeNumbers</span><span class="p">,</span>
    <span class="n">_onlyOneDimNumbers</span><span class="p">,</span>
    <span class="n">blosc_compressions</span><span class="p">,</span>
    <span class="n">setters_names_from_class</span><span class="p">,</span>
    <span class="n">slots_from_class</span><span class="p">,</span>
    <span class="n">authorized_classes</span><span class="p">,</span>
    <span class="n">Reference</span><span class="p">,</span>
    <span class="n">constructors</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">authorized_classes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;bytes&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bytearray&quot;</span><span class="p">,</span>
        <span class="s2">&quot;complex&quot;</span><span class="p">,</span>
        <span class="s2">&quot;frozenset&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tuple&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;range&quot;</span><span class="p">,</span>
        <span class="s2">&quot;set&quot;</span><span class="p">,</span>
        <span class="s2">&quot;slice&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dict_non_str_keys&quot;</span><span class="p">,</span>
        <span class="s2">&quot;collections.Counter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;collections.defaultdict&quot;</span><span class="p">,</span>
        <span class="s2">&quot;collections.deque&quot;</span><span class="p">,</span>
        <span class="s2">&quot;collections.OrderedDict&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;dumps&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dump&quot;</span><span class="p">,</span>
    <span class="s2">&quot;loads&quot;</span><span class="p">,</span>
    <span class="s2">&quot;load&quot;</span><span class="p">,</span>
    <span class="s2">&quot;append&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Encoder&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Decoder&quot;</span><span class="p">,</span>
    <span class="s2">&quot;getstate&quot;</span><span class="p">,</span>
    <span class="s2">&quot;class_from_class_str&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="c1"># flag allowing to keep None as allowed value for Encoder default_value.</span>
<span class="n">no_default_value</span> <span class="o">=</span> <span class="p">[]</span>


<span class="c1"># --- FONCTIONS BASED API ----------------------</span>


<div class="viewcode-block" id="dump"><a class="viewcode-back" href="../index.html#serializejson.dump">[docs]</a><span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">**</span><span class="n">argsDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dump an object into json file.</span>

<span class="sd">    Args:</span>
<span class="sd">        obj: object to dump.</span>
<span class="sd">        file (str or file-like): path or file.</span>
<span class="sd">        **argsDict: parameters passed to the Encoder (see documentation).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">file</span>
    <span class="n">Encoder</span><span class="p">(</span><span class="o">**</span><span class="n">argsDict</span><span class="p">)(</span><span class="n">obj</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span></div>


<div class="viewcode-block" id="dumps"><a class="viewcode-back" href="../index.html#serializejson.dumps">[docs]</a><span class="k">def</span> <span class="nf">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">**</span><span class="n">argsDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dump object into json string.</span>
<span class="sd">    If you want to return a bytes for pickle  drop-in pickle remplacement,</span>
<span class="sd">    your should ether replace `pickle.dumps` calls by `serializejson.dumpb` calls</span>
<span class="sd">    or make an `from serializejson import dumpb as dumps` at the start of your script</span>

<span class="sd">    Args:</span>
<span class="sd">        obj: object to dump.</span>
<span class="sd">        **argsDict: parameters passed to the Encoder (see documentation).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Encoder</span><span class="p">(</span><span class="o">**</span><span class="n">argsDict</span><span class="p">)(</span><span class="n">obj</span><span class="p">,</span> <span class="n">return_bytes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">dumpb</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">**</span><span class="n">argsDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dump object into json bytes.</span>

<span class="sd">    Args:</span>
<span class="sd">        obj: object to dump.</span>
<span class="sd">        **argsDict: parameters passed to the Encoder (see documentation).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Encoder</span><span class="p">(</span><span class="o">**</span><span class="n">argsDict</span><span class="p">)(</span><span class="n">obj</span><span class="p">,</span> <span class="n">return_bytes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf_8&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="append"><a class="viewcode-back" href="../index.html#serializejson.append">[docs]</a><span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">argsDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Append an object into json file.</span>

<span class="sd">    Args:</span>
<span class="sd">        obj: object to dump.</span>
<span class="sd">        file (str or file-like):</span>
<span class="sd">            path or file. The file must be empty or containing a json list.</span>
<span class="sd">        indent: indent passed to Encoder.</span>
<span class="sd">        **argsDict: other parameters passed to the Encoder (see documentation).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">_open_for_append</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">indent</span><span class="p">)</span>
    <span class="n">Encoder</span><span class="p">(</span><span class="o">**</span><span class="n">argsDict</span><span class="p">)(</span><span class="n">obj</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="n">_close_for_append</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">indent</span><span class="p">)</span></div>


<div class="viewcode-block" id="loads"><a class="viewcode-back" href="../index.html#serializejson.loads">[docs]</a><span class="k">def</span> <span class="nf">loads</span><span class="p">(</span><span class="n">json</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iterator</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">argsDict</span><span class="p">):</span>
    <span class="c1"># on ne peut pas en meme temps updater objet</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load an object from a json string or bytes.</span>

<span class="sd">    Args:</span>
<span class="sd">        json:</span>
<span class="sd">            the json string or bytes.</span>
<span class="sd">        obj (optional):</span>
<span class="sd">            If provided, the object `obj` will be updated and no new object will be created.</span>
<span class="sd">        iterator:</span>
<span class="sd">            if `True` and the json corresponds to a list then the items will be read one by one which reduces RAM consumption.</span>
<span class="sd">        **argsDict:</span>
<span class="sd">            parameters passed to the Decoder (see documentation).</span>

<span class="sd">    Return:</span>
<span class="sd">        created object, updated object if `obj` is provided or elements iterator if `iterator` is `True`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">Decoder</span><span class="p">(</span><span class="o">**</span><span class="n">argsDict</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">iterator</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">decoder</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">decoder</span><span class="p">(</span><span class="n">json</span><span class="o">=</span><span class="n">json</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span></div>


<div class="viewcode-block" id="load"><a class="viewcode-back" href="../index.html#serializejson.load">[docs]</a><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iterator</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">argsDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load an object from a json file.</span>

<span class="sd">    Args:</span>
<span class="sd">        file (str or file-like):</span>
<span class="sd">            the json path or file-like object.</span>
<span class="sd">        obj (optional):</span>
<span class="sd">            if provided, the object `obj` will be updated and no new object will be created.</span>
<span class="sd">        iterator:</span>
<span class="sd">            if `True` and the json corresponds to a list then the items will be read one by one which reduces RAM consumption.</span>
<span class="sd">        **argsDict:</span>
<span class="sd">            parameters passed to the Decoder (see documentation).</span>

<span class="sd">    Return:</span>
<span class="sd">        created object, updated object if passed obj or elements iterator if iterator is True.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">iterator</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Decoder</span><span class="p">(</span><span class="o">**</span><span class="n">argsDict</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Decoder</span><span class="p">(</span><span class="o">**</span><span class="n">argsDict</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">jsonpath</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;return the json path of loaded object&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">id_to_path</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>


<span class="c1"># --- CLASSES BASED API -------------------------------------------------------</span>


<div class="viewcode-block" id="Encoder"><a class="viewcode-back" href="../index.html#serializejson.Encoder">[docs]</a><span class="k">class</span> <span class="nc">Encoder</span><span class="p">(</span><span class="n">rapidjson</span><span class="o">.</span><span class="n">Encoder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    class for serialization of python objects into json.</span>

<span class="sd">    Args:</span>
<span class="sd">        file (str or file-like):</span>
<span class="sd">            The json path or file-like object.</span>
<span class="sd">            When specified, the encoded result will be written there</span>
<span class="sd">            if you don&#39;t pricise file to`dump()` method later.</span>

<span class="sd">        attributes_filter (bool or set/list/tuple):</span>
<span class="sd">            Controls whether remove &quot;private&quot; attributs starting with &quot;_&quot; from the saved state</span>
<span class="sd">            for objects without plugin, __getstate__,__serializejson__ or reimplemented</span>
<span class="sd">            __reduce_ex__ or __reduce__ methodes.</span>

<span class="sd">            - `False` : filter private attributes to none classes (if not filtered in __reduce__ or __gestate__ methodes)</span>
<span class="sd">            - `True` : filter private attributes for all classes</span>
<span class="sd">            - `set/list/tuple` : filter private attributes for this classes</span>

<span class="sd">            Use it temporarily.</span>

<span class="sd">            - In order to stay compatible with pickle,you sould better code one of the __getstate__, __reduce_ex__,__reduce__ or a pickle plugin, filtering attributes starting with &quot;_&quot;.</span>
<span class="sd">            - Otherwise, in order to be independent of this parameter, code a _serializejson__ method or serializejson plugin.</span>
<span class="sd">            - In this method or plugin you can call the helping function : state = serialize.__gestate__(self,attributes_filter = True)</span>

<span class="sd">        properties (bool, None, set/list/tuple, dict ):</span>
<span class="sd">            Controls whether add properties to the saved state</span>
<span class="sd">            for objects without plugin, __getstate__,__serializejson__ or reimplemented</span>
<span class="sd">            __reduce_ex__ or __reduce__ methodes.</span>

<span class="sd">            - `False` : add properties to none classes (as pickle)</span>
<span class="sd">            - `True` : add properties for all classes</span>
<span class="sd">            - `None` : (default) add properties defined in serializejson.properties dict (added by plugins or manualy before encoder call) (see documentation section: ref:`&quot;Add plugins to serializejson&quot;&lt;add-plugins-label&gt;`. )</span>
<span class="sd">            - `set/list/tuple` :  add all properties for classes in this set/list/tuple, in addition to properties defined in serializejson.properties dict [class1, class2,..] (not secure if unstruted json, use it only for debuging)</span>
<span class="sd">            - `dict` :  add properties defined in dict, in addition to properties defined in serializejson.properties dict {class1 : [&quot;propertie1&quot;,&quot;propertie1&quot;], class2: True}</span>

<span class="sd">            Use it temporarily.</span>

<span class="sd">            - In order to stay compatible with pickle, you sould better code one of the __getstate__, __reduce_ex__, __reduce__ or a pickle plugin, retrieving values for properties and returning them in the same dictionnary than __slots__, as the second element of a state tuple.</span>
<span class="sd">            - Otherwise, in order to be independent of this parameter, code a _serializejson__ method or serializejson plugin retrieving values for properties and return them in the state dictionnary.</span>
<span class="sd">            - In this method or plugin you can call the helping function : state = serialize.__gestate__(self, properties = True or list of properties names)</span>

<span class="sd">        getters (bool or set/list/tuple):</span>
<span class="sd">            Controls whether add values retrieve with getters to the saved state</span>
<span class="sd">            for objects without plugin, __getstate__,__serializejson__ or reimplemented</span>
<span class="sd">            __reduce_ex__ or __reduce__ methodes.</span>

<span class="sd">            - `False` : save no other getters than thus called in __getstate__ methodes, like pickle.</span>
<span class="sd">            - `True` : save getters for all objects</span>
<span class="sd">            - `None` : (default) save getters defined in serializejson.getter dict (added by plugins or manualy before encoder call) (see documentation section: ref:`&quot;Add plugins to serializejson&quot;&lt;add-plugins-label&gt;`. )</span>
<span class="sd">            - `set/list/tuple` : save getters for classes in set/list/tuple, in addition to getters defined in serializejson.setters dict [class1, class2,..] (not secure if unstruted json, use it only for debuging)</span>
<span class="sd">            - `dict` : save getters defined in dict, in addition to getters defined in serializejson.getters dict {class1 : {&quot;attribut_name&quot;:&quot;getter_name&quot;,...}, class2: True}</span>

<span class="sd">            Use it temporarily.</span>

<span class="sd">            - In order to stay compatible with pickle, you sould better code one of the __getstate__, __reduce_ex__, __reduce__ or a pickle plugin, retrieving values for getters and returning them in the state. And code a __setstate__ methode calling setters for this values .</span>
<span class="sd">            - Otherwise, in order to be independent of this parameter, code a _serializejson__ method or serializejson plugin retrieving values for getters and returning them in the state. And code a __setstate__ methode calling setters for this values or leave the Decpder&#39;s setters parameter as True.</span>
<span class="sd">            - In this method or plugin you can call the helping function : state = serialize.__gestate__(self,getters = True or {&quot;a&quot;:&quot;getA&quot;,&quot;b&quot;:&quot;getB&quot;}).  With getters as True, the getters will be automaticaly guessed. Wit getters as a dict allow the finest control and is faster because getters are not guessed from introspection. With tuple as key in this dict, you can retrieve several attributes values from one getter.</span>

<span class="sd">        remove_default_values (bool or set/list/tuple):</span>
<span class="sd">            Controls whether remove values same as their default value from the state in</span>
<span class="sd">            order to save memory space, for objects without plugin, __getstate__,</span>
<span class="sd">            __serializejson__ or reimplemented __reduce_ex__ or __reduce__ methodes.</span>

<span class="sd">            - `False` : remove defaul values to none classes</span>
<span class="sd">            - `True` : remove defaul values for all classes</span>
<span class="sd">            - `set/list/tuple` : remove defaul values for this classes.</span>

<span class="sd">            Use it temporarily.</span>

<span class="sd">            - Since the default values will not be stored and may change between different versions of your code, never use it for long term storage. Be aware that in order to know the default value, serializejson will create an insistence of the object&#39;s class without any __init__ argument.</span>
<span class="sd">            - In order to stay compatible with pickle, you sould better code one of the __getstate__, __reduce_ex__, __reduce__ or a pickle plugin, removing values same as their default value.</span>
<span class="sd">            - Otherwise, in order to be independent of this parameter, code a _serializejson__ method or serializejson plugin removing values same as their default value.</span>
<span class="sd">            - In this method or plugin you can call the helping function : state = serialize.__gestate__(self,remove_default_values = True or dict {name : default_value,...})</span>

<span class="sd">        chunk_size:</span>
<span class="sd">            Write the file in chunks of this size at a time.</span>

<span class="sd">        ensure_ascii:</span>
<span class="sd">            Whether non-ascii str are dumped with escaped unicode or utf-8.</span>

<span class="sd">        indent (None, int or &#39;\\\\t&#39;):</span>
<span class="sd">            Indentation width to produce pretty printed JSON.</span>

<span class="sd">            - `None` : Json in one line (quicker than with indent).</span>
<span class="sd">            - `int` : new lines and `indent` spaces for indent.</span>
<span class="sd">            - &#39;\\\\t&#39; : new lines and tabulations for indent (take less space than int &gt; 1).</span>

<span class="sd">        single_line_init:</span>
<span class="sd">            whether `__init__` args must be serialized in one line.</span>

<span class="sd">        single_line_new:</span>
<span class="sd">            whether `__new__` args must be serialized in one line.</span>

<span class="sd">        single_line_list_numbers:</span>
<span class="sd">            whether list of numbers of same type must be serialize in one line.</span>

<span class="sd">        sort_keys:</span>
<span class="sd">            whether dictionary keys should be sorted alphabetically.</span>
<span class="sd">            Since python 3.7 dictionary order is guaranteed to be insertion order.</span>
<span class="sd">            Some codes may now rely on this particular order, like the key order of the state returned by __gestate__.</span>

<span class="sd">        bytes_compression(None or str):</span>
<span class="sd">            Compression for bytes, bytesarray and numpy arrays:</span>

<span class="sd">            - `None` : no compression, use only base 64.</span>
<span class="sd">            - `str` : compression name (&quot;blosc_zstd&quot;, &quot;blosclz&quot;, &quot;blosc_lz4&quot;, &quot;blosc_lz4hc&quot; or &quot;blosc_zlib&quot;) with maximum compression level 9.</span>
<span class="sd">            - `tuple` : (compression name, compression level) with compression level from 0 (no compression) to 9 (maximum compression)</span>

<span class="sd">            By default the &quot;blosc_zstd&quot; compression is used with compression level 1.</span>
<span class="sd">            For the highest compression (but with slower dumping) use &quot;blosc_zstd&quot; with compression level 9</span>

<span class="sd">        bytes_compression_diff_dtypes (tuple of dtype)</span>
<span class="sd">            tuple of dtype for wich serialize json encode the first element followed by the differences between consecutive elements of an array before the compression.</span>
<span class="sd">            A cumulative sum will be used for the decompression</span>


<span class="sd">        bytes_compression_threads (int,str):</span>
<span class="sd">            Number of threads user for the compression</span>

<span class="sd">            - `int` : number of threads user for the compression</span>
<span class="sd">            - `&quot;cpus&quot;`: use as many thread than cpu</span>
<span class="sd">            - `&quot;determinist&quot;`  us one thread with blosc compression for determinist compression eiter as many thread than cpu</span>

<span class="sd">        bytes_size_compression_threshold (int):</span>
<span class="sd">            bytes size threshold beyond compression is tried to reduce size of</span>
<span class="sd">            bytes, bytesarray and numpy array if `bytes_compression` is not None.</span>
<span class="sd">            The default value is 512, generaly beside the compression is not</span>
<span class="sd">            worth it due to the header size and the additional cpu cost.</span>

<span class="sd">        array_readable_max_size (int,None or dict):</span>
<span class="sd">            Defines the maximum array.array size for serialization in readable numbers.</span>
<span class="sd">            By default array_readable_max_size is set to 0, all non empty arrays are encoded in base 64.</span>

<span class="sd">            - `int` : all arrays smaller than or egal to this size are serialized in readable numbers.</span>
<span class="sd">            - `None` : there is no maximum size and all arrays are serialized in readable numbers.</span>
<span class="sd">            - `dict` : for each typecode key, the value define the maximum size of this typecode arrays for serialization in readable numbers. If value is `None` there is no maximum and array of this typecode are all serialized in readable numbers. If you want only signed int arrays to be readable, then you should pass `array_readable_max_size = {&quot;i&quot;:None}`</span>

<span class="sd">            .. note::</span>
<span class="sd">                serialization of int arrays can take much less space in readable,</span>
<span class="sd">                but is much slower than in base 64 for big arrays. If you have lot or large int arrays and</span>
<span class="sd">                performance matters, then you should stay with default value 0.</span>


<span class="sd">        numpy_array_readable_max_size (int,None or dict):</span>
<span class="sd">            Defines the maximum numpy array size  (product of the array’s dimensions) for serialization in readable numbers.</span>
<span class="sd">            By default numpy_array_readable_max_size is set to 0, all non empty numpy arrays are encoded in base 64.</span>

<span class="sd">            - `int` : all numpy arrays smaller than or egal to size are serialized in readable numbers.</span>
<span class="sd">            - `None` : there is no maximum size and all numpy arrays are serialized in readable numbers.</span>
<span class="sd">            - `dict` : for each dtype key, the value define the maximum size  of this dtype arrays for serialization in readable numbers. If value is `None` there is no maximum and numpy array of this dtype are all serialized in readable numbers. If you want only numpy arrays int32 to be readable, then you should pass `numpy_array_readable_max_size = {&quot;int32&quot;:None}`</span>

<span class="sd">            .. note::</span>

<span class="sd">                serialization in readable can take much less space in int32 if the values ar smaller or equal to 9999,</span>
<span class="sd">                but is much slower than in base 64 for big arrays. If you have lot or large numpy int32 arrays and</span>
<span class="sd">                performance matters, then you should stay with default value 0.</span>

<span class="sd">        numpy_array_to_list:</span>
<span class="sd">            whether numpy array should be serialized as list.</span>

<span class="sd">            .. warning::</span>

<span class="sd">                This should be used only for interoperability with other json libraries.</span>
<span class="sd">                If you want readable  values in your json, we recommend to use instead</span>
<span class="sd">                `numpy_array_readable_max_size` which is not destructive.</span>

<span class="sd">                With `numpy_array_to_list` set to `True`:</span>

<span class="sd">                - numpy arrays will be indistinctable from list in json.</span>
<span class="sd">                - `Decoder(numpy_array_from_list=True)` will recreate numpy array from lists of bool, int or float, if not an `__init__` args list, with the the risque of unwanted convertion of lists to numpy arrays.</span>
<span class="sd">                - dtype of the numpy array will be loosed if not bool, int32 or float64 and converted to the bool, int32 or float64 when loading</span>
<span class="sd">                - Empty numpy array will be converted to [] without any way to guess the dtype and will stay an empty list when loading event with `numpy_array_from_list = True`</span>

<span class="sd">        numpy_types_to_python_types:</span>
<span class="sd">             whether numpy integers and floats outside of a array must be convert to python types.</span>
<span class="sd">             It save space and generally don&#39;t affect</span>

<span class="sd">        strict_pickle (False by default)</span>
<span class="sd">            If True serialize with exactly the same behaviour than pickle:</span>

<span class="sd">            - disabling serializejson plugins for custom serialization.(no numpyB64)</span>
<span class="sd">            - disabling attributes_filter</span>
<span class="sd">            - disabling keys sorting</span>
<span class="sd">            - disabling numpy_array_to_list</span>
<span class="sd">            - disabling numpy_types_to_python_types</span>
<span class="sd">            - keeping __dict__ and __slots__ separated in a tuple if both, instead of merge them in a dictionnary (you should prepare __setstat__ methods to receive both a tuple or a dictionnary)</span>
<span class="sd">            - making same checks than pickle</span>
<span class="sd">            - raising the sames Errors than pickle</span>

<span class="sd">        **plugins_parameters:</span>
<span class="sd">            extra keys arguments are stocked in &quot;serialize_parameters&quot;</span>
<span class="sd">            global module and accessible in plugins module in order to allow</span>
<span class="sd">            the choice between serialization options in plugins.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        bytearray_use_bytearrayB64:</span>
<span class="sd">            save bytearray with references to serializejson.bytearrayB64</span>
<span class="sd">            instead of verbose use of base64.b64decode. It save space but make</span>
<span class="sd">            the json file dependent of the serializejson module.</span>

<span class="sd">        numpy_array_use_numpyB64:</span>
<span class="sd">            save numpy arrays with references to serializejson.numpyB64</span>
<span class="sd">            instead of verbose use of base64.b64decode. It save space but make</span>
<span class="sd">            the json file dependent of the serializejson module.</span>




<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">strict_pickle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">return_bytes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">attributes_filter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">properties</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">getters</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">remove_default_values</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">chunk_size</span><span class="o">=</span><span class="mi">65536</span><span class="p">,</span>
        <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">indent</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">single_line_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">single_line_new</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">single_line_list_numbers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">bytes_compression</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;blosc_zstd&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>  <span class="c1">#</span>
        <span class="n">bytes_compression_diff_dtypes</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(),</span>
        <span class="n">bytes_size_compression_threshold</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
        <span class="n">bytes_compression_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">array_use_arrayB64</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># le laisser ?</span>
        <span class="n">array_readable_max_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># &#39;int32&#39;:-1</span>
        <span class="n">numpy_array_use_numpyB64</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># le laisser ?</span>
        <span class="n">numpy_array_readable_max_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># &#39;int32&#39;:-1</span>
        <span class="n">numpy_array_to_list</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">numpy_types_to_python_types</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">protocol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>  <span class="c1"># protocol pour pickle</span>
        <span class="o">**</span><span class="n">plugins_parameters</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="c1"># if not bytes_to_string:</span>
        <span class="c1">#   bytes_mode = rapidjson.BM_NONE</span>
        <span class="c1"># else:</span>
        <span class="c1">#    bytes_mode = rapidjson.BM_UTF8</span>

        <span class="k">if</span> <span class="n">strict_pickle</span><span class="p">:</span>
            <span class="n">attributes_filter</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">sort_keys</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">numpy_array_to_list</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">numpy_types_to_python_types</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span>
            <span class="n">ensure_ascii</span><span class="o">=</span><span class="n">ensure_ascii</span><span class="p">,</span>
            <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">,</span>
            <span class="n">sort_keys</span><span class="o">=</span><span class="n">sort_keys</span><span class="p">,</span>
            <span class="n">bytes_mode</span><span class="o">=</span><span class="n">rapidjson</span><span class="o">.</span><span class="n">BM_NONE</span><span class="p">,</span>
            <span class="n">number_mode</span><span class="o">=</span><span class="n">rapidjson</span><span class="o">.</span><span class="n">NM_NAN</span><span class="p">,</span>
            <span class="n">iterable_mode</span><span class="o">=</span><span class="n">rapidjson</span><span class="o">.</span><span class="n">IM_ONLY_LISTS</span><span class="p">,</span>
            <span class="n">mapping_mode</span><span class="o">=</span><span class="n">rapidjson</span><span class="o">.</span><span class="n">MM_ONLY_DICTS</span>
            <span class="c1"># **argsDict</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attributes_filter</span> <span class="o">=</span> <span class="n">bool_or_set</span><span class="p">(</span><span class="n">attributes_filter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">_get_properties</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getters</span> <span class="o">=</span> <span class="n">_get_getters</span><span class="p">(</span><span class="n">getters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_default_values</span> <span class="o">=</span> <span class="n">bool_or_set</span><span class="p">(</span><span class="n">remove_default_values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_bytes</span> <span class="o">=</span> <span class="n">return_bytes</span>
        <span class="k">if</span> <span class="n">indent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">single_line_list_numbers</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">single_line_init</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">single_line_new</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">single_line_list_numbers</span> <span class="o">=</span> <span class="n">single_line_list_numbers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">single_line_init</span> <span class="o">=</span> <span class="n">single_line_init</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">single_line_new</span> <span class="o">=</span> <span class="n">single_line_new</span>
        <span class="c1"># rapid json enregistre self.indent_char et self.indent_count , mais ne permet pas de savoir si indent = None ...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indent</span> <span class="o">=</span> <span class="n">indent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dump_one_line</span> <span class="o">=</span> <span class="n">indent</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dumped_classes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span> <span class="o">=</span> <span class="n">chunk_size</span>
        <span class="n">bytes_compression_level</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="k">if</span> <span class="n">bytes_compression</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bytes_compression</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">bytes_compression</span><span class="p">,</span> <span class="n">bytes_compression_level</span> <span class="o">=</span> <span class="n">bytes_compression</span>
                <span class="k">if</span> <span class="n">bytes_compression</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">blosc_compressions</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bytes_compression</span><span class="si">}</span><span class="s2"> compression unknown. Available values for bytes_compression are </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">blosc_compressions</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_compression</span> <span class="o">=</span> <span class="n">bytes_compression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_compression_threads</span> <span class="o">=</span> <span class="n">bytes_compression_threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_compression_diff_dtypes</span> <span class="o">=</span> <span class="n">bytes_compression_diff_dtypes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_compression_level</span> <span class="o">=</span> <span class="n">bytes_compression_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_size_compression_threshold</span> <span class="o">=</span> <span class="n">bytes_size_compression_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">array_use_arrayB64</span> <span class="o">=</span> <span class="n">array_use_arrayB64</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">array_readable_max_size</span> <span class="o">=</span> <span class="n">array_readable_max_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numpy_array_to_list</span> <span class="o">=</span> <span class="n">numpy_array_to_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numpy_array_use_numpyB64</span> <span class="o">=</span> <span class="n">numpy_array_use_numpyB64</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numpy_array_readable_max_size</span> <span class="o">=</span> <span class="n">numpy_array_readable_max_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numpy_types_to_python_types</span> <span class="o">=</span> <span class="n">numpy_types_to_python_types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strict_pickle</span> <span class="o">=</span> <span class="n">strict_pickle</span>

        <span class="n">unexpected_keywords_arguments</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">plugins_parameters</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">encoder_parameters</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">unexpected_keywords_arguments</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;serializejson.Encoder got unexpected keywords arguments &#39;&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unexpected_keywords_arguments</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugins_parameters</span> <span class="o">=</span> <span class="n">encoder_parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugins_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plugins_parameters</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="Encoder.dump"><a class="viewcode-back" href="../index.html#serializejson.Encoder.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dump object into json file.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj: object to dump.</span>
<span class="sd">            file (optional str or file-like):</span>
<span class="sd">                the json path or file-like object.</span>
<span class="sd">                When specified, json is written into this file.</span>
<span class="sd">                Otherwise json is written into the file passed to `Encoder()` constructor.</span>
<span class="sd">            close (optional bool):</span>
<span class="sd">               weither dump must close the file after dumping  (True by default).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fp</span> <span class="o">=</span> <span class="n">file</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">fp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">close</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp</span></div>

<div class="viewcode-block" id="Encoder.dumps"><a class="viewcode-back" href="../index.html#serializejson.Encoder.dumps">[docs]</a>    <span class="k">def</span> <span class="nf">dumps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dump object into json string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">return_bytes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="Encoder.dumpb"><a class="viewcode-back" href="../index.html#serializejson.Encoder.dumpb">[docs]</a>    <span class="k">def</span> <span class="nf">dumpb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dump object into json bytes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">return_bytes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;fp&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp</span>
        <span class="c1"># else :</span>
        <span class="c1">#    raise Exception(&quot;json file already closed&quot;)</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_serialize_parameters</span><span class="p">()</span>

        <span class="c1"># self.file = open(self.file, &quot;rb+&quot;)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb+&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;wb+&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">close</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp</span>

    <span class="c1"># @profile</span>
<div class="viewcode-block" id="Encoder.append"><a class="viewcode-back" href="../index.html#serializejson.Encoder.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Append object into json file.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj: object to dump.</span>
<span class="sd">            file (optional str or file-like): path or file. If provided, the object will be</span>
<span class="sd">                dumped into this file instead of being dumped into the file passed at the Encoder</span>
<span class="sd">                constructor. The file must be empty or contain a json list.</span>
<span class="sd">            close :</span>
<span class="sd">                - `True` the file will be closed afterappend and reopen at the next append</span>
<span class="sd">                - `False` (by default) the file will be kepped open for the next append.</span>
<span class="sd">                You will have to manually close se file with encoder.close()</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_serialize_parameters</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;fp&quot;</span><span class="p">):</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="n">_open_for_append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">_open_for_append</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">)</span>
        <span class="n">rapidjson</span><span class="o">.</span><span class="n">Encoder</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">fp</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">)</span>
        <span class="n">_close_for_append</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">close</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp</span></div>

<div class="viewcode-block" id="Encoder.get_dumped_classes"><a class="viewcode-back" href="../index.html#serializejson.Encoder.get_dumped_classes">[docs]</a>    <span class="k">def</span> <span class="nf">get_dumped_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the all dumped classes.</span>
<span class="sd">        In order to reuse them as `authorize_classes` argument when loading with a ``serializejson.Decoder``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumped_classes</span></div>

    <span class="c1"># @profile</span>
    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="c1"># Equivalent au calback &quot;default&quot; qu&#39;on peut passer à dump ou dumps</span>
        <span class="n">id_</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">id_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_already_serialized</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_path</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">already_explored</span><span class="o">=</span><span class="nb">set</span><span class="p">([</span><span class="nb">id</span><span class="p">(</span><span class="nb">locals</span><span class="p">())]))</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">rapidjson</span><span class="o">.</span><span class="n">RawJSON</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;$ref&quot;</span><span class="si">:</span><span class="s1"> &quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&quot;</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_already_serialized</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>
        <span class="n">type_inst</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">numpy_types_to_python_types</span> <span class="ow">and</span> <span class="n">type_inst</span> <span class="ow">in</span> <span class="n">_numpy_types</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_numpy_dtypes_to_python_types</span><span class="p">[</span><span class="n">type_inst</span><span class="p">](</span><span class="n">inst</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_numpy</span> <span class="ow">and</span> <span class="n">type_inst</span> <span class="ow">is</span> <span class="n">ndarray</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">numpy_array_to_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dump_one_line</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_line_list_numbers</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">inst</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="p">)</span>  <span class="c1"># A REVOIR : pas génial... va tester si nombres tous du meme type et ne pas pas utiliser rapidjson.NM_NATIVE?</span>
            <span class="k">if</span> <span class="n">inst</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="n">_numpy_float_dtypes</span><span class="p">:</span>
                <span class="n">number_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_mode</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">number_mode</span> <span class="o">=</span> <span class="n">rapidjson</span><span class="o">.</span><span class="n">NM_NATIVE</span>  <span class="c1"># permet décceler pas mal</span>
            <span class="k">if</span> <span class="n">inst</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">rapidjson</span><span class="o">.</span><span class="n">RawJSON</span><span class="p">(</span>
                    <span class="n">rapidjson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="n">inst</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                        <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">number_mode</span><span class="o">=</span><span class="n">number_mode</span><span class="p">,</span>
                        <span class="n">iterable_mode</span><span class="o">=</span><span class="n">rapidjson</span><span class="o">.</span><span class="n">IM_ONLY_LISTS</span><span class="p">,</span>
                        <span class="n">mapping_mode</span><span class="o">=</span><span class="n">rapidjson</span><span class="o">.</span><span class="n">MM_ONLY_DICTS</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="n">rapidjson</span><span class="o">.</span><span class="n">RawJSON</span><span class="p">(</span>
                    <span class="n">rapidjson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="n">elt</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                        <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">number_mode</span><span class="o">=</span><span class="n">number_mode</span><span class="p">,</span>
                        <span class="n">iterable_mode</span><span class="o">=</span><span class="n">rapidjson</span><span class="o">.</span><span class="n">IM_ONLY_LISTS</span><span class="p">,</span>
                        <span class="n">mapping_mode</span><span class="o">=</span><span class="n">rapidjson</span><span class="o">.</span><span class="n">MM_ONLY_DICTS</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">inst</span>
            <span class="p">]</span>  <span class="c1"># inst.tolist()</span>
        <span class="k">if</span> <span class="n">type_inst</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="c1"># isinstance(inst,tuple) attrape les struct_time # je l&#39;ai mis là plutot que dans tuple_from_instance car très spécifique à json et les tuples n&#39;ont pas de réduce contrairement à set , qui lui est pour l&#39;instant traité dans dict_from_instance -&gt; tuple_from_instance</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumped_classes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">tuple</span><span class="p">)</span>
            <span class="n">dic</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;__class__&quot;</span><span class="p">:</span> <span class="s2">&quot;tuple&quot;</span><span class="p">,</span> <span class="s2">&quot;__new__&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">inst</span><span class="p">)}</span>
        <span class="k">elif</span> <span class="n">type_inst</span> <span class="ow">is</span> <span class="n">Reference</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rapidjson</span><span class="o">.</span><span class="n">RawJSON</span><span class="p">(</span>
                <span class="s1">&#39;{&quot;$ref&quot;: &quot;</span><span class="si">%s%s</span><span class="s1">&quot;}&#39;</span>
                <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_path</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">already_explored</span><span class="o">=</span><span class="nb">set</span><span class="p">([</span><span class="nb">id</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)])),</span>
                    <span class="n">inst</span><span class="o">.</span><span class="n">sup_str</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict_from_instance</span><span class="p">(</span>
                <span class="n">inst</span>
            <span class="p">)</span>  <span class="c1"># 8.6 % (correspond au temps pour conversion en b64 avec pybase64.b64encode) du temps sur obj = bytes(numpy.arange(2**20,dtype=numpy.float64).data)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dump_one_line</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_line_init</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__init__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="c1"># 91.2 % du temps avec obj = bytes(numpy.arange(2**20,dtype=numpy.float64).data)</span>
                    <span class="n">dic</span><span class="p">[</span><span class="s2">&quot;__init__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rapidjson</span><span class="o">.</span><span class="n">RawJSON</span><span class="p">(</span>
                        <span class="n">rapidjson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="n">args</span><span class="p">,</span>
                            <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensure_ascii</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_one_line</span><span class="p">,</span>
                            <span class="n">sort_keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_keys</span><span class="p">,</span>
                            <span class="n">bytes_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bytes_mode</span><span class="p">,</span>
                            <span class="n">number_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">number_mode</span><span class="p">,</span>
                            <span class="n">iterable_mode</span><span class="o">=</span><span class="n">rapidjson</span><span class="o">.</span><span class="n">IM_ONLY_LISTS</span><span class="p">,</span>
                            <span class="n">mapping_mode</span><span class="o">=</span><span class="n">rapidjson</span><span class="o">.</span><span class="n">MM_ONLY_DICTS</span>
                            <span class="c1"># **self.kargs</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_line_new</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__new__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">dic</span><span class="p">[</span>
                        <span class="s2">&quot;__new__&quot;</span>
                        <span class="c1"># 91.2 % du temps avec obj = bytes(numpy.arange(2**20,dtype=numpy.float64).data)</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">rapidjson</span><span class="o">.</span><span class="n">RawJSON</span><span class="p">(</span>
                        <span class="n">rapidjson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="n">args</span><span class="p">,</span>
                            <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensure_ascii</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_one_line</span><span class="p">,</span>
                            <span class="n">sort_keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_keys</span><span class="p">,</span>
                            <span class="n">bytes_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bytes_mode</span><span class="p">,</span>
                            <span class="n">number_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">number_mode</span><span class="p">,</span>
                            <span class="n">iterable_mode</span><span class="o">=</span><span class="n">rapidjson</span><span class="o">.</span><span class="n">IM_ONLY_LISTS</span><span class="p">,</span>
                            <span class="n">mapping_mode</span><span class="o">=</span><span class="n">rapidjson</span><span class="o">.</span><span class="n">MM_ONLY_DICTS</span>
                            <span class="c1"># **self.kargs</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_line_list_numbers</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dic</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;__class__&quot;</span>
                        <span class="ow">and</span> <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;__init__&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_line_init</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;__new__&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_line_new</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span>
                        <span class="ow">and</span> <span class="n">_onlyOneDimSameTypeNumbers</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="p">):</span>

                        <span class="n">dic</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">rapidjson</span><span class="o">.</span><span class="n">RawJSON</span><span class="p">(</span>
                            <span class="n">rapidjson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                <span class="n">value</span><span class="p">,</span>
                                <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensure_ascii</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_one_line</span><span class="p">,</span>
                                <span class="n">bytes_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bytes_mode</span><span class="p">,</span>
                                <span class="n">number_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">number_mode</span><span class="p">,</span>
                                <span class="n">iterable_mode</span><span class="o">=</span><span class="n">rapidjson</span><span class="o">.</span><span class="n">IM_ONLY_LISTS</span><span class="p">,</span>
                                <span class="n">mapping_mode</span><span class="o">=</span><span class="n">rapidjson</span><span class="o">.</span><span class="n">MM_ONLY_DICTS</span>
                                <span class="c1"># **self.kargs</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
        <span class="c1"># self._already_serialized_id_dic_to_obj_dic[id(dic)] = (</span>
        <span class="c1"># inst,</span>
        <span class="c1">#    dic,</span>
        <span class="c1"># )  # important de metre dic avec sinon il va être detruit et son identifiant va être réutilisé.</span>
        <span class="c1"># if self.add_id:</span>
        <span class="c1">#    dic[&quot;_id&quot;] = id_</span>
        <span class="k">return</span> <span class="n">dic</span>
        <span class="c1"># raise TypeError(&#39;%r is not JSON serializable&#39; % inst)</span>

    <span class="c1"># @profile</span>
    <span class="k">def</span> <span class="nf">_default_one_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="n">type_inst</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">numpy_types_to_python_types</span> <span class="ow">and</span> <span class="n">type_inst</span> <span class="ow">in</span> <span class="n">_numpy_types</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_numpy_dtypes_to_python_types</span><span class="p">[</span><span class="n">type_inst</span><span class="p">](</span><span class="n">inst</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">type_inst</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="c1"># isinstance(inst,tuple) attrape les struct_time # je l&#39;ai mis là plutot que dans tuple_from_instance car très spécifique à json et les tuples n&#39;ont pas de réduce contrairement à set , qui lui est pour l&#39;instant traité dans dict_from_instance -&gt; tuple_from_instance</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumped_classes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">tuple</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;__class__&quot;</span><span class="p">:</span> <span class="s2">&quot;tuple&quot;</span><span class="p">,</span> <span class="s2">&quot;__new__&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">inst</span><span class="p">)}</span>
        <span class="k">if</span> <span class="n">type_inst</span> <span class="ow">is</span> <span class="n">Reference</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;$ref&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_path</span><span class="p">(</span>
                    <span class="n">inst</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">already_explored</span><span class="o">=</span><span class="nb">set</span><span class="p">([</span><span class="nb">id</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)])</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="n">inst</span><span class="o">.</span><span class="n">sup_str</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="n">type_inst</span> <span class="ow">is</span> <span class="n">ndarray</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">numpy_array_to_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">inst</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict_from_instance</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_dict_from_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>  <span class="c1"># dictionnary with non string key</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;__class__&quot;</span><span class="p">:</span> <span class="s2">&quot;dict_non_str_keys&quot;</span><span class="p">}</span>
            <span class="n">init_dict</span> <span class="o">=</span> <span class="n">d</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">inst</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># if type(key) is tuple :</span>
                <span class="c1">#    key = list(key)</span>
                <span class="n">new_key</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">type_key</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">type_key</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                    <span class="c1"># pas mis les float pour garder -inf et inf (nan ca déconne dans les dictionnaires)</span>
                    <span class="n">new_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">type_key</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">rapidjson</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                            <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
                            <span class="ow">or</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;b&#39;&quot;</span><span class="p">)</span>
                            <span class="ow">or</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;b64&#39;&quot;</span><span class="p">)</span>
                        <span class="p">):</span>
                            <span class="n">new_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_key</span> <span class="o">=</span> <span class="n">key</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="k">elif</span> <span class="n">type_key</span> <span class="ow">is</span> <span class="nb">bytes</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">new_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;b&#39;</span><span class="si">{</span><span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii_printables&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">new_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;b64&#39;</span><span class="si">{</span><span class="n">b64encode_as_string</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="k">elif</span> <span class="n">type_key</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">new_key</span> <span class="o">=</span> <span class="n">rapidjson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="n">key</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_one_line</span><span class="p">,</span>
                        <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ensure_ascii</span><span class="p">,</span>
                        <span class="n">sort_keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_keys</span><span class="p">,</span>
                        <span class="n">bytes_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bytes_mode</span><span class="p">,</span>
                        <span class="n">number_mode</span><span class="o">=</span><span class="n">rapidjson</span><span class="o">.</span><span class="n">NM_NATIVE</span><span class="p">,</span>
                        <span class="n">iterable_mode</span><span class="o">=</span><span class="n">rapidjson</span><span class="o">.</span><span class="n">IM_ONLY_LISTS</span><span class="p">,</span>
                        <span class="c1"># mapping_mode=rapidjson.MM_ONLY_DICTS</span>
                        <span class="c1"># **self.kargs</span>
                    <span class="p">)</span>
                <span class="n">init_dict</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">d</span>
        <span class="c1"># if type(inst) is OrderedDict :</span>
        <span class="c1">#    if not self.sort_keys :  # on a besoin d&#39;avoir accès à self.sort_keys et specifique à serializejson</span>
        <span class="c1">#        return {</span>
        <span class="c1">#                &quot;__class__&quot; : &quot;collections.OrderedDict&quot;,</span>
        <span class="c1">#                &quot;__items__&quot; : dict(inst)</span>
        <span class="c1">#                }</span>
        <span class="c1">#    else :</span>
        <span class="c1">#        return {</span>
        <span class="c1">#                &quot;__class__&quot; : &quot;collections.OrderedDict&quot;,</span>
        <span class="c1">#                &quot;__items__&quot; : list(inst.items())</span>
        <span class="c1">#                }</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span> <span class="ow">is</span> <span class="n">dotdict</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
        <span class="n">class_</span><span class="p">,</span> <span class="n">initArgs</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">listitems</span><span class="p">,</span> <span class="n">dictitems</span><span class="p">,</span> <span class="n">newArgs</span> <span class="o">=</span> <span class="n">tuple_from_instance</span><span class="p">(</span>
            <span class="n">inst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">class_</span> <span class="o">=</span> <span class="n">class_str_from_class</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dumped_classes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span>
        <span class="n">dictionnaire</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;__class__&quot;</span><span class="p">:</span> <span class="n">class_</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">args</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">((</span><span class="n">newArgs</span><span class="p">,</span> <span class="s2">&quot;__new__&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">initArgs</span><span class="p">,</span> <span class="s2">&quot;__init__&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                    <span class="n">dictionnaire</span><span class="p">[</span><span class="n">method</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">class_</span> <span class="ow">in</span> <span class="n">remove_add_braces</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
                            <span class="n">dictionnaire</span><span class="p">[</span><span class="n">method</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dictionnaire</span><span class="p">[</span><span class="n">method</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">type_first</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">type_first</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">numpy_array_to_list</span> <span class="ow">and</span> <span class="n">type_first</span> <span class="ow">is</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>
                            <span class="p">)</span>
                            <span class="ow">and</span> <span class="p">((</span><span class="n">type_first</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;__class__&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="p">):</span>
                            <span class="n">dictionnaire</span><span class="p">[</span><span class="n">method</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dictionnaire</span><span class="p">[</span><span class="n">method</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>  <span class="c1"># args is a tuple</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dictionnaire</span><span class="p">[</span><span class="n">method</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>  <span class="c1"># args is a tuple</span>
        <span class="k">if</span> <span class="n">listitems</span><span class="p">:</span>
            <span class="n">dictionnaire</span><span class="p">[</span><span class="s2">&quot;__items__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">listitems</span>
        <span class="k">elif</span> <span class="n">dictitems</span><span class="p">:</span>
            <span class="n">dictionnaire</span><span class="p">[</span><span class="s2">&quot;__items__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dictitems</span>
        <span class="k">if</span> <span class="n">state</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="s2">&quot;__setstate__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">all_keys_are_str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">dictionnaire</span><span class="p">[</span><span class="s2">&quot;__state__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dictionnaire</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dictionnaire</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">fp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_bytes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">return_bytes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">return_bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_bytes</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_line_list_numbers</span>
            <span class="ow">and</span> <span class="n">_onlyOneDimSameTypeNumbers</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">rapidjson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="n">obj</span><span class="p">,</span>
                <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_one_line</span><span class="p">,</span>
                <span class="n">bytes_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bytes_mode</span><span class="p">,</span>
                <span class="n">number_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">number_mode</span><span class="p">,</span>
                <span class="n">iterable_mode</span><span class="o">=</span><span class="n">rapidjson</span><span class="o">.</span><span class="n">IM_ONLY_LISTS</span><span class="p">,</span>
                <span class="n">mapping_mode</span><span class="o">=</span><span class="n">rapidjson</span><span class="o">.</span><span class="n">MM_ONLY_DICTS</span><span class="p">,</span>
                <span class="c1"># return_bytes = return_bytes</span>
                <span class="c1"># **self.kargs</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_serialize_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="n">encoded</span> <span class="o">=</span> <span class="n">rapidjson</span><span class="o">.</span><span class="n">Encoder</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">fp</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">encoded</span>

    <span class="k">def</span> <span class="nf">_update_serialize_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">blosc</span><span class="o">.</span><span class="n">set_nthreads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bytes_compression_threads</span><span class="p">)</span>
        <span class="n">serialize_parameters</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="n">serialize_parameters</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plugins_parameters</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dumped_classes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_already_serialized</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="c1"># self._already_serialized_id_dic_to_obj_dic = dict()</span>

    <span class="k">def</span> <span class="nf">_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_already_serialized</span>
        <span class="c1"># del self.dumped_classes</span>
        <span class="c1"># del self._already_serialized_id_dic_to_obj_dic</span>

    <span class="c1"># @profile</span>
    <span class="c1"># ,list_deep = 10):</span>
    <span class="k">def</span> <span class="nf">_searchSerializedParent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">already_explored</span><span class="o">=</span><span class="nb">set</span><span class="p">(),</span> <span class="n">attribut</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[([</span><span class="s2">&quot;root&quot;</span><span class="p">],</span> <span class="kc">False</span><span class="p">)]</span>
        <span class="n">id_obj</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">id_obj</span> <span class="ow">in</span> <span class="n">already_explored</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">already_explored</span> <span class="o">=</span> <span class="n">already_explored</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">already_explored</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id_obj</span><span class="p">)</span>
        <span class="n">already_explored</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="nb">locals</span><span class="p">()))</span>
        <span class="n">pathElements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_referrers</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">already_explored</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">refs</span><span class="p">))</span>
        <span class="c1"># potential_parents = [parent_test for parent_test in gc.get_referrers(obj)if ((id(parent_test) not in already_explored) and isinstance(parent_test,(dict,list)))  ]</span>
        <span class="c1"># print(len(potential_parents))</span>
        <span class="k">for</span> <span class="n">parent_test</span> <span class="ow">in</span> <span class="n">refs</span><span class="p">:</span>
            <span class="n">id_parent_test</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">parent_test</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">id_parent_test</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">already_explored</span><span class="p">:</span>
                <span class="n">type_parent_test</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">parent_test</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">type_parent_test</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_keys</span><span class="p">:</span>
                        <span class="n">parent_test_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">parent_test</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">parent_test_keys</span> <span class="o">=</span> <span class="n">parent_test</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">parent_test_keys</span><span class="p">:</span>  <span class="c1"># sorted(parent_test):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">parent_test</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>

                            <span class="k">for</span> <span class="n">elt</span><span class="p">,</span> <span class="n">is_attribut</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_searchSerializedParent</span><span class="p">(</span>
                                <span class="n">parent_test</span><span class="p">,</span> <span class="n">already_explored</span><span class="p">,</span> <span class="n">attribut</span><span class="o">=</span><span class="n">obj</span>
                            <span class="p">):</span>
                                <span class="k">if</span> <span class="n">is_attribut</span><span class="p">:</span>
                                    <span class="n">pathElements</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">elt</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">pathElements</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">elt</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;[&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;]&quot;</span><span class="p">],</span> <span class="kc">False</span><span class="p">))</span>

                            <span class="k">break</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="n">type_parent_test</span> <span class="ow">is</span> <span class="nb">list</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">parent_test</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="ow">is</span> <span class="n">list_iterator</span>
                <span class="p">):</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parent_test</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">elt</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_searchSerializedParent</span><span class="p">(</span>
                                <span class="n">parent_test</span><span class="p">,</span> <span class="n">already_explored</span>
                            <span class="p">):</span>
                                <span class="n">pathElements</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">elt</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;[</span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">],</span> <span class="kc">False</span><span class="p">))</span>
                            <span class="k">break</span>
                <span class="k">elif</span> <span class="n">id_parent_test</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_already_serialized</span><span class="p">:</span>

                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parent_test</span><span class="p">,</span> <span class="s2">&quot;__dict__&quot;</span><span class="p">):</span>
                        <span class="n">dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict_from_instance</span><span class="p">(</span><span class="n">parent_test</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dic</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">attribut</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">elt</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_searchSerializedParent</span><span class="p">(</span>
                                    <span class="n">parent_test</span><span class="p">,</span> <span class="n">already_explored</span>
                                <span class="p">):</span>
                                    <span class="n">pathElements</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">elt</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">key</span><span class="p">],</span> <span class="kc">True</span><span class="p">))</span>
                                    <span class="k">break</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parent_test</span><span class="p">,</span> <span class="s2">&quot;__slots__&quot;</span><span class="p">):</span>
                        <span class="n">dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict_from_instance</span><span class="p">(</span><span class="n">parent_test</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dic</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">elt</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_searchSerializedParent</span><span class="p">(</span>
                                    <span class="n">parent_test</span><span class="p">,</span> <span class="n">already_explored</span>
                                <span class="p">):</span>
                                    <span class="n">pathElements</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">elt</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">key</span><span class="p">],</span> <span class="kc">True</span><span class="p">))</span>
                                    <span class="k">break</span>

        <span class="k">return</span> <span class="n">pathElements</span>

    <span class="k">def</span> <span class="nf">_get_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">already_explored</span><span class="o">=</span><span class="nb">set</span><span class="p">()):</span>
        <span class="n">already_explored</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="nb">locals</span><span class="p">()))</span>
        <span class="n">pathElements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_searchSerializedParent</span><span class="p">(</span>
            <span class="n">obj</span><span class="p">,</span> <span class="n">already_explored</span><span class="o">=</span><span class="n">already_explored</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pathElements</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
            <span class="c1"># return f&#39;impossible to find a path from root object for {obj}&#39;</span>
            <span class="c1">#raise Exception(&quot;impossible to find a path from root object for %s&quot; % obj)</span>
            <span class="c1"># print(&quot;!&quot;,pathElements)</span>
            <span class="c1"># return pathElements[0][0]</span>

        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pathElements</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">str</span><span class="p">)])</span></div>


<div class="viewcode-block" id="Decoder"><a class="viewcode-back" href="../index.html#serializejson.Decoder">[docs]</a><span class="k">class</span> <span class="nc">Decoder</span><span class="p">(</span><span class="n">rapidjson</span><span class="o">.</span><span class="n">Decoder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decoder for loading objects serialized in json files or strings.</span>

<span class="sd">    Args:</span>
<span class="sd">        file (string or file-like):</span>
<span class="sd">            the json path or file-like object.</span>
<span class="sd">            When specified, the decoder will read json from this file</span>
<span class="sd">            if you don&#39;t pricise file to`load()` method later.</span>

<span class="sd">        authorized_classes (set/list/tuple):</span>
<span class="sd">            Define the classes that serializejson is authorized to recreate from</span>
<span class="sd">            the `__class__` keywords in json, in addition to default authorized classes</span>
<span class="sd">            and classes autorized by plugins.</span>

<span class="sd">            default authorize classes are :</span>
<span class="sd">            array.array,bytearray,bytes,range,set,slice,time.struct_time,tuple,</span>
<span class="sd">            type,frozenset,collections.Counter,collections.OrderedDict,</span>
<span class="sd">            collections.defaultdict,collections.deque,complex,datetime.date,</span>
<span class="sd">            datetime.datetime,datetime.time,datetime.timedelta,decimal.Decimal,</span>
<span class="sd">            numpy.array,numpy.bool_,numpy.dtype,numpy.float16,numpy.float32,</span>
<span class="sd">            numpy.float64,numpy.frombuffer,numpy.int16,numpy.int32,numpy.int64,</span>
<span class="sd">            numpy.int8,numpy.ndarray,numpy.uint16,numpy.uint32,numpy.uint64,</span>
<span class="sd">            numpy.uint8,numpyB64.</span>

<span class="sd">            authorized_classes must be a set/list/tuple of classes or strings</span>
<span class="sd">            corresponding to the qualified names of classes (`module.class_name`).</span>
<span class="sd">            If the loading json contain an unauthorized  `__class__`,</span>
<span class="sd">            serializejson will raise a TypeError exception.</span>

<span class="sd">            .. warning::</span>

<span class="sd">                Do not load serializejson files from untrusted / unauthenticated</span>
<span class="sd">                sources without carefully set the `authorized_classes` parameter.</span>
<span class="sd">                Never authorize &quot;eval&quot;, &quot;exec&quot;, &quot;apply&quot; or other functions or</span>
<span class="sd">                classes which could allow execution of malicious code</span>
<span class="sd">                with for example :</span>
<span class="sd">                ``{&quot;__class__&quot;:&quot;eval&quot;,&quot;__init__&quot;:&quot;do_bad_things()&quot;}``</span>

<span class="sd">        unauthorized_classes_as_dict (False by default)</span>
<span class="sd">            Controls whether unauthorized classes should be decoded as dict</span>
<span class="sd">            without raising a TypeError (or as dotdict if dotdict parameter is True,</span>
<span class="sd">            see the &quot;dotdict&quot; parameter for further explanation).</span>

<span class="sd">        recognized_classes (set/list/tuple):</span>
<span class="sd">            Classes (string with qualified names or classes) that</span>
<span class="sd">            serializejson will try to recognize from keys names.</span>
<span class="sd">            A classe will be recognized if keys names of a json dictionnary is</span>
<span class="sd">            a superset of the classe&#39;s default attributs names.</span>
<span class="sd">            Classe&#39;s default attributs name are slots and attributs names in __dict__ not starting with &quot;_&quot;</span>
<span class="sd">            after initialisation (serializejson will create an instance of each class passed in recognized_classes in order to determine</span>
<span class="sd">            this attributs)</span>
<span class="sd">            The instance will be instancied with new (with no argement), and __init__ will not be called .</span>
<span class="sd">            If you want execute some initialization code, you must add  a</span>
<span class="sd">            __setstate__() methode to your object or setter/properties with setters/properties Encoder&#39;s parameters</span>
<span class="sd">            activated.</span>


<span class="sd">        updatables_classes (set/list/tuple):</span>
<span class="sd">            Classes (string with qualified names or classes) that</span>
<span class="sd">            serializejson will try to update if already in the provided object `obj` when calling `load` or `loads`.</span>
<span class="sd">            Objects will be recreated for other classes.</span>


<span class="sd">        properties (bool, None, set/list/tuple, dict ):</span>
<span class="sd">            Controls whether `load` will call properties&#39;s setters instead of</span>
<span class="sd">            put them in self.__dict__ when the object as no `__setstate__` method</span>
<span class="sd">            and properties are merged with attributes in the state dictionnary</span>
<span class="sd">            when dumping (merged if strict_pickle is False) .</span>
<span class="sd">            - False: call properties setters for none classes (as pickle)</span>
<span class="sd">            - True : (default) call properties setters for all classes</span>
<span class="sd">            - None : call only properties setters defined in serializejson.properties dict (added by plugins or manualy before decoder call)</span>
<span class="sd">            (see documentation section: ref:`&quot;Add plugins to serializejson&quot;&lt;add-plugins-label&gt;`. )</span>
<span class="sd">            - set/list/tuple : call all properties setters for classes in this set/list/tuple, in addition to properties defined in serializejson.properties dict</span>
<span class="sd">            [class1, class2,..] (not secure if unstruted json, use it only for debuging)</span>
<span class="sd">            - dict : call properties setters defined in dict, in addition to properties defined in serializejson.properties dict</span>
<span class="sd">            {class1 : [&quot;propertie1&quot;,&quot;propertie1&quot;], class2: True}</span>


<span class="sd">            .. warning::</span>
<span class="sd">                **The properties&#39;s setters are called in the json order !**</span>
<span class="sd">                - in alphabetic order  if `sort_keys = True` or if the object has not __getstate__ method.</span>
<span class="sd">                - in the order returned by the __getstate__ method  if `sort_keys = False`</span>
<span class="sd">                - Be carefull if you rename an attribute because properties setters calls order can change.</span>
<span class="sd">                - If `properties = True` (or is a list) then serializejson load will differ from pickle that don&#39;t call attribute&#39;s setters.</span>

<span class="sd">                **It is best to add the __setate__() method to your object:**</span>
<span class="sd">                - If you want to stay compatible with pickle with the same behavior.</span>
<span class="sd">                - If you want to call properties setters in a different order than alphabetic order and don&#39;t want to code a __getstate__ method given the order.</span>
<span class="sd">                - If you want to call properties setters in a order robust to an attribute name change.</span>
<span class="sd">                - If you want to be robust to this `properties` parameter change.</span>
<span class="sd">                - If you want to avoid transitional states during setting of attribute one by one.</span>
<span class="sd">                In this method you can call the helping function :</span>
<span class="sd">                serialize.__setstate__(self,properties = True)</span>


<span class="sd">        setters  (bool,None,set/list/tuple,dict):</span>
<span class="sd">            Controls whether `load` will try to call `setxxx`,`set_xxx` or `setXxx` methods</span>
<span class="sd">            or `xxx` property setter for each attributes of the serialized objects</span>
<span class="sd">            when the object as no `__setstate__` method.</span>
<span class="sd">            - False: call no other setters than thus called in __setstate__ methodes, like pickle.</span>
<span class="sd">            - True : (default) explore and call all setters for all objects (not secure if unstruted json, use it only for debuging)</span>
<span class="sd">            - None : call only setters defined in serializejson.setters dict (added by plugins or manualy before decoder call)</span>
<span class="sd">            (see documentation section: ref:`&quot;Add plugins to serializejson&quot;&lt;add-plugins-label&gt;`. )</span>
<span class="sd">            - set/list/tuple : explore and call setters classes in set/list/tuple, in addition to setters defined in serializejson.setters dict</span>
<span class="sd">            [class1, class2,..] (not secure if unstruted json, use it only for debuging)</span>
<span class="sd">            - dict : call setters defined in dict, in addition to setters defined in serializejson.setters dict</span>
<span class="sd">            {class1 : {&quot;attribut_name&quot;:&quot;setter_name&quot;,...}, class2: True}</span>

<span class="sd">            .. warning::</span>
<span class="sd">                **The attribute&#39;s setters are called in the json order !**</span>
<span class="sd">                - in alphabetic order  if `sort_keys = True` or if the object has not __getstate__ method.</span>
<span class="sd">                - in the order returned by the __getstate__ method  if `sort_keys = False`</span>
<span class="sd">                - Be carefull if you rename an attribute because setters calls order can change.</span>
<span class="sd">                - If `set_attribute = True` (or is a list) then serializejson load will differ from pickle that don&#39;t call attribute&#39;s setters.</span>

<span class="sd">                **It is best to add the __setate__() method to your object:**</span>
<span class="sd">                - If you want to stay compatible with pickle with the same behavior.</span>
<span class="sd">                - If you want to call setters in a different order than alphabetic order and don&#39;t want to code a __getstate__ method given the order.</span>
<span class="sd">                - If you want to call setters in a order robust to an attribute name change.</span>
<span class="sd">                - If you want to be robust to this `setters` parameter change.</span>
<span class="sd">                - If you want to avoid transitional states during setting of attribute one by one.</span>
<span class="sd">                In this method you can call the helping function :</span>
<span class="sd">                serialize.__setstate__(self,setters = True or dict {name : setter_name,...})</span>

<span class="sd">        strict_pickle (False by default)</span>
<span class="sd">            If True serialize with exactly the same behaviour than pickle:</span>
<span class="sd">            - disabling properties setters</span>
<span class="sd">            - disabling setters</span>
<span class="sd">            - disabling numpy_array_from_list</span>

<span class="sd">        accept_comments (bool):</span>
<span class="sd">            Controls whether serializejson accepts to parse json with comments.</span>

<span class="sd">        numpy_array_from_list (bool):</span>
<span class="sd">            Controls whether list of bool, int or floats with same types elements should be loaded into numpy arrays.</span>

<span class="sd">        numpy_array_from_heterogenous_list (bool):</span>
<span class="sd">            Controls whether list of bool, int or floats with same or heterogenous types elements should be loaded into numpy arrays.</span>

<span class="sd">        default_value:</span>
<span class="sd">            The value returned if the path passed to `load` doesn&#39;t exist.</span>
<span class="sd">            It allows to have a default object at the first run of the script or</span>
<span class="sd">            when the json has been deleted, without raising of FileNotFoundError.</span>

<span class="sd">        chunk_size (int):</span>
<span class="sd">            Chunk size used when reading the json file.</span>

<span class="sd">        dotdict (bool):</span>
<span class="sd">            load dicts as serializejson.dotdict, a dict subclasse with acces to key names with a dot as object attributes enabled.</span>
<span class="sd">            A dotdict will be serialized as dict again when dumping.</span>
<span class="sd">            dotdict allows you to more easily access the elements of a deserialized dictionary, with the same &#39;.&#39; acces syntax as for an object, allowing you if you wish, to later transform the dictionaries in your jsons into real objects with the addition of the &quot;__class__&quot; field, without having to modify your code.</span>

<span class="sd">        add_jsonpath</span>
<span class="sd">            If True, the source json path will be added to the loaded object as `_jsonpath` attribut.</span>
<span class="sd">            If False (by default), nothing will be added to the loaded object, but you can still retrieve the source json path with the &quot;serializejson.jsonpath&quot; function which will find the path from the object identifier</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inherited from rapidjson.Decoder:</span>

<span class="sd">        number_mode (int): Enable particular behaviors in handling numbers</span>
<span class="sd">        datetime_mode (int): How should datetime, time and date instances be handled</span>
<span class="sd">        uuid_mode (int): How should UUID instances be handled</span>
<span class="sd">        parse_mode (int): Whether the parser should allow non-standard JSON extensions (nan, -inf, inf )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">authorized_classes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">unauthorized_classes_as_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">recognized_classes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">updatables_classes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">setters</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">properties</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default_value</span><span class="o">=</span><span class="n">no_default_value</span><span class="p">,</span>
        <span class="n">accept_comments</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">numpy_array_from_list</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">numpy_array_from_heterogenous_list</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">chunk_size</span><span class="o">=</span><span class="mi">65536</span><span class="p">,</span>
        <span class="n">strict_pickle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">dotdict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">add_jsonpath</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="k">if</span> <span class="n">accept_comments</span><span class="p">:</span>
            <span class="n">parse_mode</span> <span class="o">=</span> <span class="n">rapidjson</span><span class="o">.</span><span class="n">PM_COMMENTS</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parse_mode</span> <span class="o">=</span> <span class="n">rapidjson</span><span class="o">.</span><span class="n">PM_NONE</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parse_mode</span><span class="o">=</span><span class="n">parse_mode</span><span class="p">)</span>  <span class="c1"># , **argsDict)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strict_pickle</span> <span class="o">=</span> <span class="n">strict_pickle</span>
        <span class="k">if</span> <span class="n">strict_pickle</span><span class="p">:</span>
            <span class="n">setters</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">numpy_array_from_list</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">numpy_array_from_heterogenous_list</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">add_jsonpath</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setters</span> <span class="o">=</span> <span class="n">_get_setters</span><span class="p">(</span><span class="n">setters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">_get_properties</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_authorized_classes_strs</span> <span class="o">=</span> <span class="n">_get_authorized_classes_strings</span><span class="p">(</span>
            <span class="n">authorized_classes</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unauthorized_classes_as_dict</span> <span class="o">=</span> <span class="n">unauthorized_classes_as_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_class_from_attributes_names</span> <span class="o">=</span> <span class="n">_get_recognized_classes_dict</span><span class="p">(</span>
            <span class="n">recognized_classes</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_updatables_classes</span><span class="p">(</span><span class="n">updatables_classes</span><span class="p">)</span>
        <span class="c1"># self.accept_comments = accept_comments</span>
        <span class="c1"># self.numpy_array_from_list=numpy_array_from_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">default_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span> <span class="o">=</span> <span class="n">chunk_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dotdict</span> <span class="o">=</span> <span class="n">dotdict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_jsonpath</span> <span class="o">=</span> <span class="n">add_jsonpath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_iter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updating</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">numpy_array_from_list</span> <span class="o">=</span> <span class="n">numpy_array_from_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numpy_array_from_heterogenous_list</span> <span class="o">=</span> <span class="n">numpy_array_from_heterogenous_list</span>
        <span class="k">if</span> <span class="n">numpy_array_from_heterogenous_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numpy_array_from_list</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_array_if_numpy_array_from_heterogenous_list</span>
        <span class="k">elif</span> <span class="n">numpy_array_from_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_array_if_numpy_array_from_list</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="Decoder.load"><a class="viewcode-back" href="../index.html#serializejson.Decoder.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load object from json file.</span>

<span class="sd">        Args:</span>
<span class="sd">            file (optional str or file-like):</span>
<span class="sd">                the json path or file-like object.</span>
<span class="sd">                When specified, json is read  from this file.</span>
<span class="sd">                Otherwise json is read from the file passed to `Decoder()` constructor.</span>

<span class="sd">            obj (optional):</span>
<span class="sd">                If provided, the object `obj` will be updated and no new object will be created.</span>

<span class="sd">        Return:</span>
<span class="sd">            created object or updated object if passed obj.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span>
        <span class="n">path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">file</span>
            <span class="c1"># print(&quot;load&quot;,file)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_value</span> <span class="ow">is</span> <span class="n">no_default_value</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                        <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">),</span> <span class="n">file</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_value</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">_open_with_good_encoding</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># a priori pointeur vers fichier</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Encoder.load need a &quot;file&quot; path/file argument&#39;</span><span class="p">)</span>

        <span class="n">loaded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">json</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_jsonpath</span><span class="p">:</span>
                <span class="n">loaded</span><span class="o">.</span><span class="n">_jsonpath</span> <span class="o">=</span> <span class="n">path</span>
            <span class="n">id_to_path</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">loaded</span><span class="p">)]</span> <span class="o">=</span> <span class="n">path</span>
        <span class="k">return</span> <span class="n">loaded</span></div>

<div class="viewcode-block" id="Decoder.loads"><a class="viewcode-back" href="../index.html#serializejson.Decoder.loads">[docs]</a>    <span class="k">def</span> <span class="nf">loads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load object from json string or bytes.</span>

<span class="sd">        Args:</span>
<span class="sd">            s:</span>
<span class="sd">                the json string.</span>
<span class="sd">            obj (optional):</span>
<span class="sd">                If provided, the object `obj` will be updated and no new object will be created.</span>

<span class="sd">        Return:</span>
<span class="sd">            created object or updated object if passed obj.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">json</span><span class="o">=</span><span class="n">json</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span></div>

<div class="viewcode-block" id="Decoder.set_default_value"><a class="viewcode-back" href="../index.html#serializejson.Decoder.set_default_value">[docs]</a>    <span class="k">def</span> <span class="nf">set_default_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">no_default_value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the value returned if the path passed to load doesn&#39;t exist.</span>
<span class="sd">        It allows to have a default object at the first run of the script or</span>
<span class="sd">        when the json has been deleted, without raising of FileNotFoundError.</span>
<span class="sd">        encoder.set_default_value() without any argument will remove the default_value</span>
<span class="sd">        and reactivate the raise of FileNotFoundError.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="Decoder.set_authorized_classes"><a class="viewcode-back" href="../index.html#serializejson.Decoder.set_authorized_classes">[docs]</a>    <span class="k">def</span> <span class="nf">set_authorized_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define the classes that serializejson is authorized to recreate from</span>
<span class="sd">        the `__class__` keywords in json, in addition to the usuals classes.</span>
<span class="sd">        Usual classes are : complex ,bytes, bytearray, Decimal, type, set,</span>
<span class="sd">        frozenset, range, slice, deque,  datetime, timedelta, date, time</span>
<span class="sd">        numpy.array, numpy.dtype.</span>
<span class="sd">        authorized_classes must be a liste of classes or strings</span>
<span class="sd">        corresponding to the qualified names of classes (`module.class_name`).</span>
<span class="sd">        If the loading json contain an unauthorized  `__class__`,</span>
<span class="sd">        serializejson will raise a TypeError exception.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            Do not load serializejson files from untrusted / unauthenticated</span>
<span class="sd">            sources without carefully set the `authorized_classes` parameter.</span>
<span class="sd">            Never authorize &quot;eval&quot;, &quot;exec&quot;, &quot;apply&quot; or other functions or</span>
<span class="sd">            classes which could allow execution of malicious code</span>
<span class="sd">            with for example :</span>
<span class="sd">            ``{&quot;__class__&quot;:&quot;eval&quot;,&quot;__init__&quot;:&quot;do_bad_things()&quot;}``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_authorized_classes_strs</span> <span class="o">=</span> <span class="n">_get_authorized_classes_strings</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span></div>

<div class="viewcode-block" id="Decoder.set_recognized_classes"><a class="viewcode-back" href="../index.html#serializejson.Decoder.set_recognized_classes">[docs]</a>    <span class="k">def</span> <span class="nf">set_recognized_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the classes (string with qualified name or classes) that</span>
<span class="sd">        serializejson will try to recognize from key names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_class_from_attributes_names</span> <span class="o">=</span> <span class="n">_get_recognized_classes_dict</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span></div>

<div class="viewcode-block" id="Decoder.set_updatables_classes"><a class="viewcode-back" href="../index.html#serializejson.Decoder.set_updatables_classes">[docs]</a>    <span class="k">def</span> <span class="nf">set_updatables_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">updatables</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the classes (string with qualified name or classes) that</span>
<span class="sd">        serializejson will try to update if already in the provided object `obj` when loading with `load` or `loads`.</span>
<span class="sd">        Otherwise the objects are recreated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">updatableClassStrs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">updatables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">updatable</span> <span class="ow">in</span> <span class="n">updatables</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">updatable</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">updatableClassStrs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">updatable</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">updatableClassStrs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">class_str_from_class</span><span class="p">(</span><span class="n">updatable</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updatableClassStrs</span> <span class="o">=</span> <span class="n">updatableClassStrs</span></div>

    <span class="k">def</span> <span class="nf">start_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dict_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_startswith_curly</span>
        <span class="p">):</span>  <span class="c1"># en vrai c&#39;est pas forcement le root ,si par exeple le root est une liste ...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">dict_</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updating</span><span class="p">:</span>
            <span class="n">id_</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">dict_</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ancestors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dict_</span>

    <span class="k">def</span> <span class="nf">end_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="c1"># self._counter += 1</span>
        <span class="c1"># self._deserializeds.add()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updating</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ancestors</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>  <span class="c1"># se retire lui meme</span>
        <span class="n">class_str</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__class__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">class_str</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updating</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">class_str</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">updatableClassStrs</span><span class="p">:</span>
                    <span class="n">ancestor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ancestors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">node_has_descendants_to_recreate</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ancestor</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exploreDictToReCreateObjects</span><span class="p">(</span>
                        <span class="n">inst</span>
                    <span class="p">)</span>  <span class="c1"># idealement faudrait pouvoir eviter d&#39;explorer, et aller directement rédydrater les descendant , le problème c&#39;est que l&#39;hydrattation n&#39;est pas in place et les objet qui les contiennent de vont pas avoir leur champs mis à jour ... ex dans une liste</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inst_from_dict</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
        <span class="c1"># pour reconnaissant d&#39;objet juste à partir des attributes</span>
        <span class="k">elif</span> <span class="s2">&quot;$ref&quot;</span> <span class="ow">in</span> <span class="n">inst</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
                <span class="c1"># try:</span>
                <span class="n">inst_potential</span> <span class="o">=</span> <span class="n">from_name</span><span class="p">(</span>
                    <span class="n">inst</span><span class="p">[</span><span class="s2">&quot;$ref&quot;</span><span class="p">],</span> <span class="n">accept_dict_as_object</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span>
                <span class="p">)</span>  <span class="c1"># essaye de remplacer tout de suite si possible</span>
                <span class="k">if</span> <span class="n">inst</span> <span class="ow">is</span> <span class="n">inst_potential</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;{&quot;$ref&quot;: &quot;</span><span class="si">%s</span><span class="s1">&quot;} pointing to himself&#39;</span> <span class="o">%</span>
                                    <span class="n">inst</span><span class="p">[</span><span class="s2">&quot;$ref&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">inst_potential</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                    <span class="c1"># verifie que ce n&#39;est pas un objet qui n&#39;a pas encore été recré</span>
                    <span class="k">return</span> <span class="n">inst_potential</span>
                <span class="k">if</span> <span class="s2">&quot;__class__&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inst_potential</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">inst_potential</span>
                <span class="n">inst_potential_epured</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">key</span><span class="p">:</span> <span class="n">inst_potential</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;__class__&quot;</span><span class="p">,</span> <span class="s2">&quot;__init__&quot;</span><span class="p">,</span> <span class="s2">&quot;__new__&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inst_potential</span>
                <span class="p">}</span>
                <span class="n">inst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inst_from_dict</span><span class="p">(</span><span class="n">inst_potential_epured</span><span class="p">)</span>
                <span class="n">inst_potential</span><span class="p">[</span><span class="s2">&quot;__class__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inst</span>
                <span class="k">return</span> <span class="n">inst</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_to_replace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_class_from_attributes_names</span><span class="p">:</span>
            <span class="n">class_from_attributes_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_class_from_attributes_names</span>
            <span class="n">attributes_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">attributes_tuple</span> <span class="ow">in</span> <span class="n">class_from_attributes_names</span><span class="p">:</span>
                <span class="n">inst</span><span class="p">[</span><span class="s2">&quot;__class__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">class_from_attributes_names</span><span class="p">[</span><span class="n">attributes_tuple</span><span class="p">]</span>
                <span class="n">recognized</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">attributes_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">attributes_tuple</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">attribute_names</span> <span class="ow">in</span> <span class="n">class_from_attributes_names</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">attributes_set</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">attribute_names</span><span class="p">):</span>
                        <span class="n">inst</span><span class="p">[</span><span class="s2">&quot;__class__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">class_from_attributes_names</span><span class="p">[</span><span class="n">attribute_names</span><span class="p">]</span>
                        <span class="n">recognized</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">recognized</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">recognized</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updating</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inst</span><span class="p">[</span><span class="s2">&quot;__class__&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">updatableClassStrs</span><span class="p">:</span>
                        <span class="n">ancestor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ancestors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">node_has_descendants_to_recreate</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ancestor</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># idealement faudrait pouvoir eviter d&#39;explorer, et aller directement rédydrater les descendant , le problème c&#39;est que l&#39;hydrattation n&#39;est pas in place et les objet qui les contiennent de vont pas avoir leur champs mis à jour ... ex dans une liste</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exploreDictToReCreateObjects</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># pas de verification les objets recognized sont considérés comme authorized  #self._inst_from_dict(inst)</span>
                    <span class="k">return</span> <span class="n">instance</span><span class="p">(</span><span class="o">**</span><span class="n">inst</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dotdict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dotdict</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inst</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            json : file-like, str or bytes (UTF-8) containing the JSON to be decoded</span>
<span class="sd">            obj : object to update (optional)</span>


<span class="sd">        Returns:</span>
<span class="sd">            a python value</span>

<span class="sd">        examples:</span>
<span class="sd">            &gt;&gt;&gt; decoder = Decoder()</span>
<span class="sd">            &gt;&gt;&gt; decoder(&#39;&quot;€ 0.50&quot;&#39;)</span>
<span class="sd">            &#39;€ 0.50&#39;</span>
<span class="sd">            &gt;&gt;&gt; decoder(b&#39;&quot;\xe2\x82\xac 0.50&quot;&#39;)</span>
<span class="sd">            &#39;€ 0.50&#39;</span>
<span class="sd">            &gt;&gt;&gt; decoder(io.StringIO(&#39;&quot;€ 0.50&quot;&#39;))</span>
<span class="sd">            &#39;€ 0.50&#39;</span>
<span class="sd">            &gt;&gt;&gt; decoder(io.BytesIO(b&#39;&quot;\xe2\x82\xac 0.50&quot;&#39;))</span>
<span class="sd">            &#39;€ 0.50&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">blosc</span><span class="o">.</span><span class="n">set_nthreads</span><span class="p">(</span><span class="n">blosc</span><span class="o">.</span><span class="n">ncores</span><span class="p">)</span>
        <span class="n">serialize_parameters</span><span class="o">.</span><span class="n">strict_pickle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strict_pickle</span>
        <span class="n">serialize_parameters</span><span class="o">.</span><span class="n">setters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setters</span>
        <span class="n">serialize_parameters</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converted_numpy_array_from_lists</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="c1"># self._counter = 0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updating</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># for duplicates -----------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json_startswith_curly</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json_startswith_curly</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;{&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json_startswith_curly</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;{&quot;</span><span class="p">)</span>
            <span class="n">json</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_to_replace</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># for updating ------------------</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_updating</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">loaded</span> <span class="o">=</span> <span class="n">rapidjson</span><span class="o">.</span><span class="n">Decoder</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># update</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_updating</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ancestors</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ancestors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node_has_descendants_to_recreate</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">loaded_dict</span> <span class="o">=</span> <span class="n">rapidjson</span><span class="o">.</span><span class="n">Decoder</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span>
            <span class="p">)</span>
            <span class="n">loaded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exploreToUpdate</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">loaded_dict</span><span class="p">)</span>
        <span class="c1"># on restaure doublons qu&#39;on a pu restaurer pendant deserialisation (dans une liste ou doublon referencant un parent)</span>
        <span class="n">duplicates_to_replace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_to_replace</span>
        <span class="k">if</span> <span class="n">duplicates_to_replace</span><span class="p">:</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>  <span class="c1"># pas sur qu&#39;indispensable mais dans le doute  https://docs.python.org/3/library/gc.html#gc.get_referrers</span>
            <span class="k">while</span> <span class="n">duplicates_to_replace</span><span class="p">:</span>
                <span class="n">duplicate_to_replace</span> <span class="o">=</span> <span class="n">duplicates_to_replace</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">referenced</span> <span class="o">=</span> <span class="n">from_name</span><span class="p">(</span>
                    <span class="n">duplicate_to_replace</span><span class="p">[</span><span class="s2">&quot;$ref&quot;</span><span class="p">],</span>
                    <span class="n">accept_dict_as_object</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">root</span><span class="o">=</span><span class="n">loaded</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">referenced</span> <span class="ow">is</span> <span class="n">duplicate_to_replace</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;{&quot;$ref&quot;: &quot;</span><span class="si">%s</span><span class="s1">&quot;} pointing to himself&#39;</span> <span class="o">%</span>
                                    <span class="n">duplicate_to_replace</span><span class="p">[</span><span class="s2">&quot;$ref&quot;</span><span class="p">])</span>
                <span class="n">refs</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_referrers</span><span class="p">(</span><span class="n">duplicate_to_replace</span><span class="p">)</span>
                <span class="n">skip</span> <span class="o">=</span> <span class="p">(</span><span class="nb">locals</span><span class="p">(),</span> <span class="n">refs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">refs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">parent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">duplicate_to_replace</span><span class="p">:</span>
                                    <span class="n">parent</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">referenced</span>
                                    <span class="k">break</span>
                        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parent</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">duplicate_to_replace</span><span class="p">:</span>
                                    <span class="n">parent</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">referenced</span>
                                    <span class="k">break</span>
                        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;__slots__&quot;</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="vm">__slots__</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span>
                                    <span class="nb">hasattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">slot</span><span class="p">)</span>
                                    <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">slot</span><span class="p">)</span> <span class="ow">is</span> <span class="n">duplicate_to_replace</span>
                                <span class="p">):</span>
                                    <span class="nb">setattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">referenced</span><span class="p">)</span>
                                    <span class="k">break</span>
        <span class="c1"># clean ---------------</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicates_to_replace</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_updating</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">ancestors</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_has_descendants_to_recreate</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_updating</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="k">return</span> <span class="n">loaded</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updating</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">default_value</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_iter</span> <span class="o">=</span> <span class="n">_json_object_file_iterator</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;not yet able to load_iter on </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">file</span><span class="p">)))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_inst_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="n">class_str</span> <span class="o">=</span> <span class="n">inst</span><span class="p">[</span><span class="s2">&quot;__class__&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">class_str</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authorized_classes_strs</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">class_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;__init__&quot;</span><span class="p">,</span> <span class="s2">&quot;__new__&quot;</span><span class="p">,</span> <span class="s2">&quot;__items__&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inst</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">numpy_array_from_list</span>
                        <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inst</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="nb">id</span><span class="p">(</span><span class="n">inst</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">converted_numpy_array_from_lists</span>
                    <span class="p">):</span>
                        <span class="n">inst</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">inst</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;__items__&quot;</span> <span class="ow">and</span> <span class="n">class_str</span> <span class="ow">in</span> <span class="n">remove_add_braces</span><span class="p">:</span>
                        <span class="n">inst</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">inst</span><span class="p">[</span><span class="n">key</span><span class="p">],)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">inst</span><span class="p">[</span><span class="s2">&quot;__class__&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;dict_non_str_keys&quot;</span>
            <span class="p">):</span>  <span class="c1"># je l&#39;ai mis ici car trop specifique à json pour etre dans tools (qui est partagé avec serializePython et serializeRepr)</span>
                <span class="k">return</span> <span class="n">dict_non_str_keys</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">instance</span><span class="p">(</span><span class="o">**</span><span class="n">inst</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unauthorized_classes_as_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dotdict</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">inst</span><span class="p">[</span><span class="s1">&#39;__class__&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> not in authorized_classes leaved as docdict&quot;</span><span class="p">,</span>
                    <span class="ne">Warning</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">dotdict</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">inst</span><span class="p">[</span><span class="s1">&#39;__class__&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> not in authorized_classes leaved as dict&quot;</span><span class="p">,</span> <span class="ne">Warning</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">inst</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">inst</span><span class="p">[</span><span class="s1">&#39;__class__&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not in authorized_classes&quot;</span><span class="p">)</span>

    <span class="c1"># @profile</span>
    <span class="k">def</span> <span class="nf">_exploreToUpdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">loaded_node</span><span class="p">):</span>

        <span class="c1"># gère le cas où loaded_node est un dictionnaire ----------------------</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loaded_node</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">obj_keys</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># plutot que set vide un objet peut ne pas avoir d&#39;attributes ni de slots initialisés</span>
            <span class="n">obj_class</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="k">if</span> <span class="n">obj_class</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;dict&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">updatableClassStrs</span><span class="p">):</span>
                <span class="n">is_dict</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">obj_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="n">obj</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># s&#39;assure que c&#39;est une instance</span>
                <span class="n">is_dict</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">class_str</span> <span class="o">=</span> <span class="n">loaded_node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__class__&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">class_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="n">class_str</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">updatableClassStrs</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="n">class_str</span> <span class="o">==</span> <span class="n">class_str_from_class</span><span class="p">(</span><span class="n">obj_class</span><span class="p">))</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">class_str</span> <span class="o">==</span> <span class="s2">&quot;set&quot;</span><span class="p">:</span>
                        <span class="c1"># on peut udpate le set MAIS PAS LES OJECTS QUI SONT DEDANS !!!! car on ne sait pas quel existant correspond à quel element json</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exploreDictToReCreateObjects</span><span class="p">(</span><span class="n">loaded_node</span><span class="p">))</span>
                        <span class="k">return</span> <span class="n">obj</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__setstate__&quot;</span><span class="p">):</span>
                        <span class="c1"># j&#39;ai du remplacer hasMethod(inst,&quot;__setstate__&quot;) par hasattr(inst,&quot;__setstate__&quot;) pour pouvoir deserialiser des sklearn.tree._tree.Tree en json &quot;__setstate__&quot; n&#39;est pas reconnu comme étant une methdoe !? alors que bien là .</span>
                        <span class="k">if</span> <span class="s2">&quot;__state__&quot;</span> <span class="ow">in</span> <span class="n">loaded_node</span><span class="p">:</span>
                            <span class="n">obj</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">loaded_node</span><span class="p">[</span><span class="s2">&quot;__state__&quot;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">loaded_node</span><span class="o">.</span><span class="fm">__delitem__</span><span class="p">(</span><span class="s2">&quot;__class__&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="s2">&quot;__init__&quot;</span> <span class="ow">in</span> <span class="n">loaded_node</span><span class="p">:</span>
                                <span class="n">loaded_node</span><span class="o">.</span><span class="fm">__delitem__</span><span class="p">(</span><span class="s2">&quot;__init__&quot;</span><span class="p">)</span>
                            <span class="n">obj</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">loaded_node</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">obj</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__dict__&quot;</span><span class="p">):</span>
                        <span class="c1"># A REVOIR : ne marche pas avec les slots</span>
                        <span class="n">obj_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__slots__&quot;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">obj_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">obj_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">slots_from_class</span><span class="p">(</span><span class="n">obj_class</span><span class="p">):</span>
                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">slot</span><span class="p">):</span>
                                <span class="n">obj_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">slot</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj_keys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_dict</span><span class="p">:</span>

                    <span class="n">setters</span> <span class="o">=</span> <span class="n">serialize_parameters</span><span class="o">.</span><span class="n">setters</span>

                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">setters</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                        <span class="n">setters</span> <span class="o">=</span> <span class="n">setters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj_class</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">setters</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">setters</span> <span class="o">=</span> <span class="n">setters_names_from_class</span><span class="p">(</span><span class="n">obj_class</span><span class="p">)</span>

                <span class="c1"># update dans le cas où l&#39;objet pré-existant est un objet (avec __dict__ pas encore __slot__) ou un dictionnaire --</span>
                <span class="n">loaded_node_has_descendants_to_recreate</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">id</span><span class="p">(</span><span class="n">loaded_node</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_has_descendants_to_recreate</span>
                <span class="p">)</span>

                <span class="c1"># suprime les attributes de l&#39;objet qui ne sont pas dans loaded..</span>
                <span class="n">only_in_obj</span> <span class="o">=</span> <span class="n">obj_keys</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">loaded_node</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">only_in_obj</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">is_dict</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
                        <span class="n">obj</span><span class="o">.</span><span class="fm">__delattr__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

                <span class="c1"># update ou recrer les autres attributes</span>

                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">loaded_node</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;__class__&quot;</span><span class="p">,</span> <span class="s2">&quot;__init__&quot;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">obj_keys</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">is_dict</span><span class="p">:</span>
                                <span class="n">old_value</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">old_value</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exploreToUpdate</span><span class="p">(</span><span class="n">old_value</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">loaded_node_has_descendants_to_recreate</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exploreDictToReCreateObjects</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exploreListToReCreateObjects</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">is_dict</span><span class="p">:</span>
                            <span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="k">elif</span> <span class="n">setters</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">setters</span><span class="p">:</span>
                            <span class="n">obj</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">setters</span><span class="p">[</span><span class="n">key</span><span class="p">])(</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">obj</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">obj</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exploreDictToReCreateObjects</span><span class="p">(</span><span class="n">loaded_node</span><span class="p">)</span>

        <span class="c1"># gère le cas où loaded_node est une liste ---------------------------</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loaded_node</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;list&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">updatableClassStrs</span><span class="p">):</span>
                <span class="c1"># update dans le cas où l&#39;objet pré-existant est une liste</span>
                <span class="n">len_obj</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">obj</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">loaded_node</span><span class="p">):]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">loaded_node</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len_obj</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
                        <span class="n">obj</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exploreToUpdate</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exploreDictToReCreateObjects</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exploreListToReCreateObjects</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">obj</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># sinon replace</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exploreListToReCreateObjects</span><span class="p">(</span><span class="n">loaded_node</span><span class="p">)</span>

        <span class="c1"># gère les autres cas</span>
        <span class="k">return</span> <span class="n">loaded_node</span>  <span class="c1"># replace</span>

    <span class="k">def</span> <span class="nf">_exploreDictToReCreateObjects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loaded_node</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">loaded_node</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_has_descendants_to_recreate</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">loaded_node</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="c1"># and &quot;__class__&quot; in value</span>
                    <span class="n">loaded_node</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exploreDictToReCreateObjects</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">loaded_node</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exploreListToReCreateObjects</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;__class__&quot;</span> <span class="ow">in</span> <span class="n">loaded_node</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inst_from_dict</span><span class="p">(</span><span class="n">loaded_node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">loaded_node</span>

    <span class="k">def</span> <span class="nf">_exploreListToReCreateObjects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loaded_node</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">loaded_node</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">loaded_node</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exploreDictToReCreateObjects</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">loaded_node</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exploreListToReCreateObjects</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loaded_node</span>

    <span class="c1"># ---------------------------------</span>

    <span class="k">def</span> <span class="nf">_end_array_if_numpy_array_from_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_onlyOneDimSameTypeNumbers</span><span class="p">(</span><span class="n">sequence</span><span class="p">):</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">sequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">converted_numpy_array_from_lists</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">array</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">array</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sequence</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ndarray</span><span class="p">):</span>
            <span class="n">first_elt</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">first_elt_shape</span> <span class="o">=</span> <span class="n">first_elt</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">first_elt_dtype</span> <span class="o">=</span> <span class="n">first_elt</span><span class="o">.</span><span class="n">dtype</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">elt</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">elt</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">is</span> <span class="n">first_elt_dtype</span>
                    <span class="ow">and</span> <span class="n">elt</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">first_elt_shape</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">sequence</span>
            <span class="p">):</span>
                <span class="n">array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">first_elt_dtype</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">converted_numpy_array_from_lists</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">array</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">array</span>
        <span class="k">return</span> <span class="n">sequence</span>

    <span class="k">def</span> <span class="nf">_end_array_if_numpy_array_from_heterogenous_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_onlyOneDimNumbers</span><span class="p">(</span><span class="n">sequence</span><span class="p">):</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">converted_numpy_array_from_lists</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">array</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">array</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sequence</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ndarray</span><span class="p">):</span>
            <span class="n">first_elt</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">first_elt_shape</span> <span class="o">=</span> <span class="n">first_elt</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
                <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">elt</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">elt</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">first_elt_shape</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">sequence</span>
            <span class="p">):</span>
                <span class="n">array</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">converted_numpy_array_from_lists</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">array</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">array</span>
        <span class="k">return</span> <span class="n">sequence</span>

    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rapidjson</span><span class="o">.</span><span class="n">Decoder</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_iter</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">rapidjson</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_iter</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">error</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Parse error at offset 0: The document is empty.&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">StopIteration</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span></div>


<span class="c1"># ----------------------------------------------------------------------------------------------------------------------------</span>
<span class="c1"># --- INTERNES -----------------------------------------------------------------------------------------------------</span>
<span class="c1"># ----------------------------------------------------------------------------------------------------------------------------</span>
<span class="k">class</span> <span class="nc">dotdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;dot notation access to dictionary attributes&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">()</span>

    <span class="fm">__setattr__</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__setitem__</span>
    <span class="fm">__delattr__</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__delitem__</span>


<span class="k">def</span> <span class="nf">bool_or_set</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span>


<span class="k">def</span> <span class="nf">bool_or_dict</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="kc">True</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">value</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span>


<span class="k">def</span> <span class="nf">dict_non_str_keys</span><span class="p">(</span><span class="n">dict_</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">dict_</span><span class="p">[</span><span class="s2">&quot;__class__&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dict_</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;b&#39;&quot;</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii_printables&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;b64&#39;&quot;</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">b64decode</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">d</span>


<span class="k">def</span> <span class="nf">all_keys_are_str</span><span class="p">(</span><span class="n">dict_</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dict_</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">if</span> <span class="n">use_numpy</span><span class="p">:</span>
    <span class="n">_numpy_float_dtypes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s2">&quot;float16&quot;</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s2">&quot;float64&quot;</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="n">_numpy_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">bool_</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">uint64</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_numpy_float_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_numpy_int_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">uint64</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">_numpy_dtypes_to_python_types</span> <span class="o">=</span> <span class="p">{</span><span class="n">numpy</span><span class="o">.</span><span class="n">bool_</span><span class="p">:</span> <span class="nb">bool</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">numpy_type</span> <span class="ow">in</span> <span class="n">_numpy_int_types</span><span class="p">:</span>
        <span class="n">_numpy_dtypes_to_python_types</span><span class="p">[</span><span class="n">numpy_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span>
    <span class="k">for</span> <span class="n">numpy_type</span> <span class="ow">in</span> <span class="n">_numpy_float_types</span><span class="p">:</span>
        <span class="n">_numpy_dtypes_to_python_types</span><span class="p">[</span><span class="n">numpy_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">_numpy_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>


<span class="n">NoneType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">remove_add_braces</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;set&quot;</span><span class="p">,</span>
    <span class="s2">&quot;frozenset&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tuple&quot;</span><span class="p">,</span>
    <span class="s2">&quot;collections.OrderedDict&quot;</span><span class="p">,</span>
    <span class="s2">&quot;collections.Counter&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_close_for_append</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">indent</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">indent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">]&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_open_for_append</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">indent</span><span class="p">):</span>
    <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">remove_last_square_close</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">fp</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb+&quot;</span><span class="p">)</span>
            <span class="c1"># detect encoding</span>
            <span class="n">bytes_</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">len_bytes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bytes_</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">len_bytes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bytes_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">bytes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r+&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf_32_be&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r+&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf_16_be&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">len_bytes</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">bytes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">len_bytes</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">bytes_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r+&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf_32_le&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r+&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf_16_le&quot;</span><span class="p">)</span>
            <span class="c1"># remove last ]</span>
            <span class="n">remove_last_square_close</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
            <span class="n">remove_last_square_close</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">fp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Incorrect file (file, str ou unicode)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">remove_last_square_close</span><span class="p">:</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;serializejson can append only to serialized lists&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># va sur le dernier caractère</span>
            <span class="n">lastcChar</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lastcChar</span> <span class="ow">in</span> <span class="p">(</span><span class="sa">b</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="s2">&quot;]&quot;</span><span class="p">):</span>
                <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">beforlastcChar</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">beforlastcChar</span> <span class="ow">in</span> <span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
                    <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># va sur le dernier caractère</span>
                <span class="n">fp</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;serializejson can append only to serialized lists&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">indent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;[&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;[</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">indent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fp</span>


<span class="k">def</span> <span class="nf">_open_with_good_encoding</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="c1"># https://stackoverflow.com/questions/4990095/json-specification-and-usage-of-bom-charset-encoding/38036753</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">bytes_</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">len_bytes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bytes_</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">len_bytes</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">bytes_</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xef\xbb\xbf</span><span class="s2">&quot;</span>
        <span class="p">):</span>  <span class="c1"># normalement ne devrait pas arriver les json ne devraient jamais commencer par un BOM , mais parfoit si le fichier à été créer à la main dans un editeur de text, il peut y&#39;en avoir un (exemple : personnel.json ).</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf_8_sig&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">bytes_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bytes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf_32_be&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf_16_be&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">len_bytes</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">bytes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">len_bytes</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">bytes_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf_32_le&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf_16_le&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fp</span>


<span class="k">def</span> <span class="nf">_get_authorized_classes_strings</span><span class="p">(</span><span class="n">classes</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">classes</span><span class="p">]</span>
    <span class="n">_authorized_classes_strs</span> <span class="o">=</span> <span class="n">authorized_classes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">elt</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">elt</span> <span class="o">=</span> <span class="n">class_str_from_class</span><span class="p">(</span><span class="n">elt</span><span class="p">)</span>
        <span class="n">_authorized_classes_strs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">elt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_authorized_classes_strs</span>


<span class="k">def</span> <span class="nf">_get_recognized_classes_dict</span><span class="p">(</span><span class="n">classes</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">classes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">classes</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">classes</span>
    <span class="n">_class_from_attributes_names</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">class_</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">classToRecStr</span> <span class="o">=</span> <span class="n">class_</span>
            <span class="n">classToRecClass</span> <span class="o">=</span> <span class="n">class_from_class_str</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">classToRecStr</span> <span class="o">=</span> <span class="n">class_str_from_class</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span>
            <span class="n">classToRecClass</span> <span class="o">=</span> <span class="n">class_</span>
        <span class="n">serializedattributes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">instanceVide</span> <span class="o">=</span> <span class="n">classToRecClass</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">instanceVide</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="n">slots_from_class</span><span class="p">(</span><span class="n">class_</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attribute</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
                <span class="n">serializedattributes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
        <span class="n">serializedattributes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">serializedattributes</span><span class="p">))</span>
        <span class="n">_class_from_attributes_names</span><span class="p">[</span><span class="n">serializedattributes</span><span class="p">]</span> <span class="o">=</span> <span class="n">classToRecStr</span>
    <span class="k">return</span> <span class="n">_class_from_attributes_names</span>


<span class="k">class</span> <span class="nc">_json_object_file_iterator</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">FileIO</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">io</span><span class="o">.</span><span class="n">FileIO</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_quotes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_curlys</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_squares</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_simple</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_object</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backslash_escape</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shedule_break</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_chunk_start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># s = io.FileIO.read(self, 1)</span>
        <span class="c1"># if s not in (b&quot;[&quot;, &quot;[&quot;):</span>
        <span class="c1">#    raise Exception(&#39;the json data must start with &quot;[&quot;&#39;)</span>
        <span class="k">if</span> <span class="s2">&quot;b&quot;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interesting</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;</span><span class="si">{}</span><span class="s1">[]&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">separators</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;, </span><span class="se">\t\n\r</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;</span><span class="si">{}</span><span class="s1">[]&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interesting</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;</span><span class="si">{}</span><span class="s1">[]&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">separators</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="s2">&quot;, </span><span class="se">\t\n\r</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;</span><span class="si">{}</span><span class="s1">[]&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shedule_break</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shedule_break</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># print(&quot;read(1): empty&quot;)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="p">(</span>
            <span class="n">backslash</span><span class="p">,</span>
            <span class="n">doublecote</span><span class="p">,</span>
            <span class="n">curly_open</span><span class="p">,</span>
            <span class="n">curly_close</span><span class="p">,</span>
            <span class="n">square_open</span><span class="p">,</span>
            <span class="n">square_close</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chars</span>
        <span class="n">interesting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interesting</span>
        <span class="n">separators</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separators</span>
        <span class="n">in_quotes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_quotes</span>
        <span class="n">in_curlys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_curlys</span>
        <span class="n">in_squares</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_squares</span>
        <span class="n">in_simple</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_simple</span>
        <span class="n">in_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_object</span>
        <span class="n">backslash_escape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backslash_escape</span>  <span class="c1"># true if we just saw a backslash</span>
        <span class="n">in_chunk_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_chunk_start</span>
        <span class="k">if</span> <span class="n">in_chunk_start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">FileIO</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">in_chunk_start</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">in_simple</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">separators</span> <span class="ow">or</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="mi">93</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">in_chunk_start</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">:</span>
                        <span class="c1"># on prevoit d&#39;arreter au read suivant sinon , va de tout facon arreter et on ne pourra pas remeter self.shedule_break à False</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">shedule_break</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># self.seek(chunk_start + i + 1)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_chunk_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_quotes</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_curlys</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_squares</span> <span class="o">=</span> <span class="n">in_squares</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_simple</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_object</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="c1"># print(&quot;read(2): &quot;,s[in_chunk_start:i])</span>
                    <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="n">in_chunk_start</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">interesting</span><span class="p">:</span>
                <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">in_quotes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">backslash_escape</span><span class="p">:</span>
                        <span class="c1"># we must have just seen a backslash; reset that flag and continue</span>
                        <span class="n">backslash_escape</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">backslash</span><span class="p">:</span>
                        <span class="n">backslash_escape</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># we are in a quote and we see a backslash; escape next char</span>
                    <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">doublecote</span><span class="p">:</span>
                        <span class="n">in_quotes</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="c1"># signale qu&#39;on sort d&#39;un truc et qu&#39;il faudra checker</span>
                        <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">doublecote</span><span class="p">:</span>  <span class="c1"># &quot;</span>
                    <span class="n">in_quotes</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">in_object</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">curly_open</span><span class="p">:</span>  <span class="c1"># {</span>
                    <span class="n">in_curlys</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">in_object</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">curly_close</span><span class="p">:</span>  <span class="c1"># }</span>
                    <span class="n">in_curlys</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">square_open</span><span class="p">:</span>  <span class="c1"># [</span>
                    <span class="n">in_squares</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">in_squares</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">in_object</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">in_chunk_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">square_close</span><span class="p">:</span>  <span class="c1"># ]</span>
                    <span class="n">in_squares</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">in_squares</span><span class="p">:</span>  <span class="c1"># on a ateint la fin de la liste json</span>
                        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">check</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">in_quotes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">in_curlys</span> <span class="ow">and</span> <span class="n">in_squares</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">in_chunk_start</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="c1"># on prevoit d&#39;arreter au read suivant sinon , va de tout facon arreter et on ne pourra pas remeter self.shedule_break à False</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">shedule_break</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># self.seek(chunk_start + i + 1)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_chunk_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_quotes</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_curlys</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_squares</span> <span class="o">=</span> <span class="n">in_squares</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_simple</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_object</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="c1"># print(&quot;read(3): &quot;,s[in_chunk_start: i + 1])</span>
                    <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="n">in_chunk_start</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">in_object</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">separators</span><span class="p">:</span>
                    <span class="n">in_chunk_start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">in_simple</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_quotes</span> <span class="o">=</span> <span class="n">in_quotes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_curlys</span> <span class="o">=</span> <span class="n">in_curlys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_squares</span> <span class="o">=</span> <span class="n">in_squares</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_simple</span> <span class="o">=</span> <span class="n">in_simple</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_object</span> <span class="o">=</span> <span class="n">in_object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backslash_escape</span> <span class="o">=</span> <span class="n">backslash_escape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_chunk_start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">in_chunk_start</span><span class="p">:</span>
            <span class="c1"># print(&quot;read(4): &quot;,s[in_chunk_start:])</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="n">in_chunk_start</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">s</span>


<span class="n">id_to_path</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Baptiste de La Gorce

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>